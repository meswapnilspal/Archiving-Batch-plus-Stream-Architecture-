{"version":"NotebookV1","origId":2709619314154896,"name":"POC_Upsert_merge","language":"python","commands":[{"version":"CommandV1","origId":2709619314154897,"guid":"a03668fe-1343-4205-a717-ddff3ade8333","subtype":"command","commandType":"auto","position":1.0,"command":"#Step 1 : Create Dataframe on CT dataset\n\n# File location and type\nfile_location = \"/FileStore/tables/demochangesheet_ct-2.csv\"\nfile_type = \"csv\"\n\n# CSV options\ninfer_schema = \"True\"\nfirst_row_is_header = \"True\"\ndelimiter = \",\"\n\n# The applied options are for CSV files. For other file types, these will be ignored.\ndfupdate = spark.read.format(file_type) \\\n  .option(\"inferSchema\", infer_schema) \\\n  .option(\"header\", first_row_is_header) \\\n  .option(\"sep\", delimiter) \\\n  .load(file_location)\n\ndisplay(dfupdate)","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cd6c704a-6475-444a-87a6-9dc34443999f"},{"version":"CommandV1","origId":2709619314154898,"guid":"c5b3abf5-a5e5-4d66-a9cc-94140959f457","subtype":"command","commandType":"auto","position":2.0,"command":"# Step 2 : Create directory to store Delta data in Filestore\ndbutils.fs.mkdirs(\"/FileStore/tables/target/delta2\")","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"af19c83e-0075-499b-b9f0-682e87d3a98e"},{"version":"CommandV1","origId":2709619314154899,"guid":"2fdcd6a0-603e-4f13-9614-dd951a64d21f","subtype":"command","commandType":"auto","position":3.0,"command":"%fs ls /FileStore/tables/target/delta2","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e891823d-c05c-45fd-81f4-19486c89be00"},{"version":"CommandV1","origId":2709619314154900,"guid":"a8c6be70-275a-417c-b724-37369603e48c","subtype":"command","commandType":"auto","position":4.0,"command":"#Step 3: Create delta table on Dataframe \"Initial load / Initial table creation\"\n# No need to repeat it again for CT Dataframes\ndfupdate.write.format(\"delta\").mode(\"overwrite\").save(\"/FileStore/tables/target/delta2/\")","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"0422b3cb-8cae-4027-9d3e-112cd23c90f1"},{"version":"CommandV1","origId":2709619314154901,"guid":"2f36b45f-78dd-4534-a2e0-966e7e6b4541","subtype":"command","commandType":"auto","position":5.0,"command":"%sql\nselect * FROM DELTA.`/FileStore/tables/target/delta2/`","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ea1abcd6-8098-4b9f-a895-da7d63f1c181"},{"version":"CommandV1","origId":2709619314154902,"guid":"de93210e-7a9f-4b81-940f-62a09e928fab","subtype":"command","commandType":"auto","position":6.0,"command":"#Step 4 : Merge logic \n\nfrom delta.tables import *\n\ndeltaTableTarget = DeltaTable.forPath(spark, '/FileStore/tables/target/delta2/')\ndeltaTableUpdates = dfupdate\n\ndfUpdates = deltaTableUpdates\n\ndeltaTableTarget.alias('target') \\\n  .merge(\n    dfUpdates.alias('update'),\n    'target.MANDT = update.MANDT AND target.BELNR = update.BELNR AND target.BELZEILE = update.BELZEILE'\n  ) \\\n  .whenMatchedUpdate(set =\n    {\n      \"MANDT\"\t: \"update.MANDT\",\n      \"BELNR\"\t: \"update.BELNR\",\n      \"BELZEILE\" : \"update.BELZEILE\",\t\n      \"EQUNR\"\t: \"update.EQUNR\",\n      \"GERAET\" : \"update.GERAET\",\t\n      \"MATNR\"\t: \"update.MATNR\",\n      \"ZWNUMMER\" : \"update.ZWNUMMER\",\n      \"INDEXNR\" : \"update.INDEXNR\",\n      \"ABLESGR\" : \"update.ABLESGR\",\t\n      \"ABLESGRV\" : \"update.ABLESGRV\",\t\n      \"ATIM\" : \"update.ATIM\",\t\n      \"ATIMVA\" : \"update.ATIMVA\",\t\n      \"ADATMAX\" : \"update.ADATMAX\",\t\n      \"ATIMMAX\" : \"update.ATIMMAX\",\t\n      \"THGDATUM\" : \"update.THGDATUM\",\t\n      \"ZUORDDAT\" : \"update.ZUORDDAT\",\t\n      \"REGRELSORT\" : \"update.REGRELSORT\",\t\n      \"ABLBELNR\" : \"update.ABLBELNR\",\t\n      \"LOGIKNR\" : \"update.LOGIKNR\",\t\n      \"LOGIKZW\" : \"update.LOGIKZW\",\t\n      \"ISTABLART\" : \"update.ISTABLART\",\t\n      \"ISTABLARTVA\" : \"update.ISTABLARTVA\",\t\n      \"EXTPKZ\" : \"update.EXTPKZ\",\t\n      \"BEGPROG\" : \"update.BEGPROG\",\t\n      \"ENDEPROG\" : \"update.ENDEPROG\",\t\n      \"ABLHINW\" : \"update.ABLHINW\",\t\n      \"V_ZWSTAND\" : \"update.V_ZWSTAND\",\t\n      \"N_ZWSTAND\" : \"update.N_ZWSTAND\",\t\n      \"V_ZWSTNDAB\" : \"update.V_ZWSTNDAB\",\t\n      \"N_ZWSTNDAB\" : \"update.N_ZWSTNDAB\",\t\n      \"V_ZWSTVOR\" : \"update.V_ZWSTVOR\",\t\n      \"N_ZWSTVOR\" : \"update.N_ZWSTVOR\",\t\n      \"V_ZWSTDIFF\" : \"update.V_ZWSTDIFF\",\t\n      \"N_ZWSTDIFF\" : \"update.N_ZWSTDIFF\",\t\n      \"QDPROC\" : \"update.QDPROC\",\t\n      \"MRCONNECT\" : \"update.MRCONNECT\",\t\n      \"op_indicator\" : \"update.op_indicator\",\n      \"op_timestamp\" : \"update.op_timestamp\",\t\n      \"insertedTS\" : \"update.insertedTS\"\n    }\n  ) \\\n  .whenNotMatchedInsert(values =\n    {\n      \"MANDT\"\t: \"update.MANDT\",\n      \"BELNR\"\t: \"update.BELNR\",\n      \"BELZEILE\" : \"update.BELZEILE\",\t\n      \"EQUNR\"\t: \"update.EQUNR\",\n      \"GERAET\" : \"update.GERAET\",\t\n      \"MATNR\"\t: \"update.MATNR\",\n      \"ZWNUMMER\" : \"update.ZWNUMMER\",\n      \"INDEXNR\" : \"update.INDEXNR\",\n      \"ABLESGR\" : \"update.ABLESGR\",\t\n      \"ABLESGRV\" : \"update.ABLESGRV\",\t\n      \"ATIM\" : \"update.ATIM\",\t\n      \"ATIMVA\" : \"update.ATIMVA\",\t\n      \"ADATMAX\" : \"update.ADATMAX\",\t\n      \"ATIMMAX\" : \"update.ATIMMAX\",\t\n      \"THGDATUM\" : \"update.THGDATUM\",\t\n      \"ZUORDDAT\" : \"update.ZUORDDAT\",\t\n      \"REGRELSORT\" : \"update.REGRELSORT\",\t\n      \"ABLBELNR\" : \"update.ABLBELNR\",\t\n      \"LOGIKNR\" : \"update.LOGIKNR\",\t\n      \"LOGIKZW\" : \"update.LOGIKZW\",\t\n      \"ISTABLART\" : \"update.ISTABLART\",\t\n      \"ISTABLARTVA\" : \"update.ISTABLARTVA\",\t\n      \"EXTPKZ\" : \"update.EXTPKZ\",\t\n      \"BEGPROG\" : \"update.BEGPROG\",\t\n      \"ENDEPROG\" : \"update.ENDEPROG\",\t\n      \"ABLHINW\" : \"update.ABLHINW\",\t\n      \"V_ZWSTAND\" : \"update.V_ZWSTAND\",\t\n      \"N_ZWSTAND\" : \"update.N_ZWSTAND\",\t\n      \"V_ZWSTNDAB\" : \"update.V_ZWSTNDAB\",\t\n      \"N_ZWSTNDAB\" : \"update.N_ZWSTNDAB\",\t\n      \"V_ZWSTVOR\" : \"update.V_ZWSTVOR\",\t\n      \"N_ZWSTVOR\" : \"update.N_ZWSTVOR\",\t\n      \"V_ZWSTDIFF\" : \"update.V_ZWSTDIFF\",\t\n      \"N_ZWSTDIFF\" : \"update.N_ZWSTDIFF\",\t\n      \"QDPROC\" : \"update.QDPROC\",\t\n      \"MRCONNECT\" : \"update.MRCONNECT\",\t\n      \"op_indicator\" : \"update.op_indicator\",\n      \"op_timestamp\" : \"update.op_timestamp\",\t\n      \"insertedTS\" : \"update.insertedTS\"\n    }\n  ) \\\n  .execute()","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cda0159f-5c6a-4f7a-8b9b-f77431d39c6b"},{"version":"CommandV1","origId":2709619314154903,"guid":"720d480e-1fb8-42d6-bb0c-7679cc19cdb6","subtype":"command","commandType":"auto","position":7.0,"command":"%sql\n\nSelect * from Delta.`/FileStore/tables/target/delta2/`","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"8ab1c750-1edd-45f6-80ac-708bfddfab94"}],"dashboards":[],"guid":"e63b390d-39b3-420c-9287-05b30ab302ac","globalVars":{},"iPythonMetadata":{"nbformat":4,"IPythonMetadata":{}},"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}