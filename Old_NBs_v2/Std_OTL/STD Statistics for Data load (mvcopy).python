{"version":"NotebookV1","origId":2709619314154994,"name":"STD Statistics for Data load (mvcopy)","language":"python","commands":[{"version":"CommandV1","origId":2709619314154995,"guid":"429f1565-6ddf-498a-a33e-7e695b37f8f6","subtype":"command","commandType":"auto","position":2.0,"command":"#%run \"/EDA/Data Engineer/Framework/Secrets-Databricks-Cache\"","commandVersion":2,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b5129767-e730-49dc-b751-6bda7816e879"},{"version":"CommandV1","origId":2709619314154996,"guid":"8e82c33b-b5c7-47c1-a7d5-05dc3732274b","subtype":"command","commandType":"auto","position":3.0,"command":"# SET ENVIRONMENT FOR DATA LAKE (02 OR 10 OR etc)\ndbutils.widgets.text(\"env\", \"02\", \"ADLS ENVIRONMENT\")\nenv = dbutils.widgets.get(\"env\")\n\n#SET BASEPATH\nbasepath = 'abfss://dev@dtecuprodedaadl' + env + '.dfs.core.windows.net/'\n\n#SET SEGREGATED LOCATION PATH \ndbutils.widgets.text(\"segregated_loc\", \"raw/ISU_archive/segregated\", \"SEGREGATED LOC\")\nsegregated_loc = basepath + dbutils.widgets.get(\"segregated_loc\")\n\n#SET STAGING COLLECTED LOCATION PATH \ndbutils.widgets.text(\"staging_collected_loc\", \"raw/ISU_archive/staging_collected\", \"STAGING COLLECTED LOC\")\nstaging_collected_loc = basepath + dbutils.widgets.get(\"staging_collected_loc\")\n\n#SET TARGET LOCATION PATH FOR LOGGING STATISTICS EXCELS\ndbutils.widgets.text(\"statistics_loc\", \"ISU_archive_support/statistics\", \"STATISTICS LOC\")\nstatistics_loc = basepath + dbutils.widgets.get(\"statistics_loc\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7f9810dc-5624-445a-8abe-8c485584f83f"},{"version":"CommandV1","origId":2709619314154997,"guid":"85aa2b51-87fc-4882-a5c5-1bdca465abd9","subtype":"command","commandType":"auto","position":4.0,"command":"print(\"basepath : \" + basepath)\nprint(\"segregated_loc : \" + segregated_loc)\nprint(\"staging_collected_loc : \" + staging_collected_loc)\nprint(\"statistics_loc : \" + statistics_loc)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5612cf9e-d89e-4b20-95d2-ce18f19444a3"},{"version":"CommandV1","origId":2709619314154998,"guid":"b2b285ed-889b-455a-b7f5-d4cc9c5c2144","subtype":"command","commandType":"auto","position":5.0,"command":"%md\n\n# Row Count per File","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b253831f-797c-413e-b906-144ab22ee0e1"},{"version":"CommandV1","origId":2709619314154999,"guid":"7dc30938-23a1-444b-a576-04d5ae0052ad","subtype":"command","commandType":"auto","position":6.0,"command":"from pyspark.sql import functions as F\nfrom pyspark.sql.functions import split\nfrom pyspark.sql.functions import *\n\n#FOR DAILY LOAD STATS\n\ndf_csv = spark.read.csv(segregated_loc + \"/*\") \\\n    .withColumn(\"FilePath\", F.input_file_name()) \\\n    .groupby(\"FilePath\") \\\n    .agg(F.count(\"*\").alias(\"Row_Count_per_file\"))\ndf = df_csv.withColumn(\"FileNameRaw\", split((\"FilePath\"), \"/\").getItem(7))\ndf1 = df.withColumn(\"TableName\", split((\"FilePath\"), \"/\").getItem(6))\nnewDf = df1.withColumn('FileName', regexp_replace('FileNameRaw', '%23', '#'))\ndisplay(newDf[[\"FileName\", \"TableName\", \"Row_Count_per_file\"]])","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e55eac70-2bdd-47c0-a7e2-e2370fa986ee"},{"version":"CommandV1","origId":2709619314155000,"guid":"63c4c0a5-dfa0-4d03-a603-60a826778c63","subtype":"command","commandType":"auto","position":7.0,"command":"from pyspark.sql import functions as F\nfrom pyspark.sql.functions import split\nfrom pyspark.sql.functions import *\n\n#FOR TOTAL STATS\n\ndf_csv_tot = spark.read.csv(staging_collected_loc + \"/*\") \\\n    .withColumn(\"FilePath\", F.input_file_name()) \\\n    .groupby(\"FilePath\") \\\n    .agg(F.count(\"*\").alias(\"Row_Count_per_file\"))\ndf_tot = df_csv_tot.withColumn(\"FileNameRaw\", split((\"FilePath\"), \"/\").getItem(6))\ndf1_tot = df_tot.withColumn(\"TableName\", split((\"FileNameRaw\"), \"%23\").getItem(3))\nnewDf_tot = df1_tot.withColumn('FileName', regexp_replace('FileNameRaw', '%23', '#'))\ndisplay(newDf_tot[[\"FileName\", \"TableName\", \"Row_Count_per_file\"]])\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"3304b290-5a17-4eef-9e00-5fa658d6b40e"},{"version":"CommandV1","origId":2709619314155001,"guid":"78789de8-6a98-4f30-9963-f8473bfc8efa","subtype":"command","commandType":"auto","position":8.0,"command":"%md\n# Total File Counts","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6192afde-3495-4213-b88e-46ed5f967b19"},{"version":"CommandV1","origId":2709619314155002,"guid":"56ba50e2-1be5-46db-bca2-0a5bb79a44b9","subtype":"command","commandType":"auto","position":9.0,"command":"newDf.count()","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"fadfeb21-fd80-472b-97ba-d88816b9699f"},{"version":"CommandV1","origId":2709619314155003,"guid":"113360da-a3d3-4f4f-b7f5-9b0bf66c49aa","subtype":"command","commandType":"auto","position":10.0,"command":"%md\n# Count of Files per Table","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b03ed431-1d88-4d15-aa34-f787f7449ee2"},{"version":"CommandV1","origId":2709619314155004,"guid":"cf851c37-78a6-4084-b042-c1f820ba0e5c","subtype":"command","commandType":"auto","position":11.0,"command":"newDf2 =  newDf \\\n    .groupby(\"TableName\") \\\n    .agg(F.count(\"*\").alias(\"File_Count_per_Table\"))\n#display(newDf2[[\"TableName\",\"File_Count_per_Table\"]])\n\nnewDf2_tot =  newDf_tot \\\n    .groupby(\"TableName\") \\\n    .agg(F.count(\"*\").alias(\"File_Count_per_Table\"))","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7cf4c5d4-93ee-4781-9106-3af9c9d937e7"},{"version":"CommandV1","origId":2709619314155005,"guid":"0dc39725-2648-4ce6-8ca4-352784890724","subtype":"command","commandType":"auto","position":12.0,"command":"%md\n# Rows per table","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"d3e9d63f-90f1-431f-bb6b-a53ee5456cfb"},{"version":"CommandV1","origId":2709619314155006,"guid":"aede8598-fd46-4e4a-b52e-fef691ef80c1","subtype":"command","commandType":"auto","position":13.0,"command":"newDf3 =  newDf \\\n    .groupby(\"TableName\") \\\n    .agg(F.sum(\"Row_Count_per_file\").alias(\"Row_Count_per_Table\"))\n#display(newDf3[[\"TableName\",\"Row_Count_per_Table\"]])\n\nnewDf3_tot =  newDf_tot \\\n    .groupby(\"TableName\") \\\n    .agg(F.sum(\"Row_Count_per_file\").alias(\"Row_Count_per_Table\"))","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"622e369f-3192-4126-8441-8152355f5a7c"},{"version":"CommandV1","origId":2709619314155007,"guid":"afd3cead-b476-46fd-abfd-14fabb7a1abb","subtype":"command","commandType":"auto","position":14.0,"command":"%md\n# History tables stats","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"dbfbcf37-8f5a-4cd2-8506-e0b3547e8489"},{"version":"CommandV1","origId":2709619314155008,"guid":"24ee5762-082d-4f4b-a9a7-7424209f1d9a","subtype":"command","commandType":"auto","position":15.0,"command":"\ndftablename = spark.sql(f\"\"\"SHOW TABLES FROM cods_nonprod_historical like '*archive';\"\"\")\n#display(dftablename)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"0dbf982d-ab7b-4651-834a-045be0a68c4a"},{"version":"CommandV1","origId":2709619314155009,"guid":"0167d927-f182-46ae-b725-ef20206a156b","subtype":"command","commandType":"auto","position":16.0,"command":"from pyspark.sql import SparkSession\nfrom pyspark.sql.types import *\nfrom pyspark.sql.functions import col\nfrom pyspark.sql.functions import lit\n\nspark = SparkSession.builder.appName('Empty_Dataframe').getOrCreate()\n\ncolumns = StructType([StructField('TOTAL_ROW_COUNT',\n                                  StringType(), True),\n                    StructField('TODAYS_MERGED_COUNT',\n                                  StringType(), True),\n                    StructField('TABLE_NAME',\n                                StringType(), True),\n                    StructField('DATABASE',\n                                StringType(), True)])\n\nempRDD = spark.sparkContext.emptyRDD()\n\ndffn1 = spark.createDataFrame(data = empRDD , schema = columns)\n\ndf_collect = dftablename.collect()\nfor row in df_collect:\n    var_db = row[\"database\"]\n    var_tn = row[\"tableName\"]\n    dffn2 = spark.sql(f\"\"\"SELECT  COUNT(*) as TOTAL_ROW_COUNT ,(SELECT  COUNT(*) FROM {var_db}.{var_tn} WHERE date(EDA_Creation_date) = current_date()) as TODAYS_MERGED_COUNT FROM {var_db}.{var_tn}\"\"\")    \n    dffn3 = dffn2.withColumn(\"TableName\",lit(var_tn))\n    dffn4 = dffn3.withColumn(\"Database\",lit(var_db))\n    dffn1 = dffn1.union(dffn4)\n#display(dffn1)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"48d6fcc2-3b84-484f-9480-bdb7b58070a1"},{"version":"CommandV1","origId":2709619314155010,"guid":"f79bbea8-3d91-400a-8523-1a18197ab88e","subtype":"command","commandType":"auto","position":17.0,"command":"%md\n# Stream tables stats","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"1babe950-9d4e-4a3b-a23d-64f36fde1cbf"},{"version":"CommandV1","origId":2709619314155011,"guid":"fa1f0593-18e7-4943-902b-9ebdde78c58d","subtype":"command","commandType":"auto","position":18.0,"command":"dfstreamtablename = spark.sql(f\"\"\"SHOW TABLES FROM cods_nonprod_active like '*current';\"\"\")\n#display(dfstreamtablename)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"054a9d6c-eeec-4ebf-99da-54f26517f1e3"},{"version":"CommandV1","origId":2709619314155012,"guid":"a3979c42-7d27-4387-8540-d066832c71e7","subtype":"command","commandType":"auto","position":19.0,"command":"# from pyspark.sql import SparkSession\n# from pyspark.sql.types import *\n# from pyspark.sql.functions import col\n# from pyspark.sql.functions import lit\n\n# spark = SparkSession.builder.appName('Empty_Dataframe').getOrCreate()\n\n# columns = StructType([StructField('TOTAL_ROW_COUNT',\n#                                   StringType(), True),\n#                     StructField('TODAYS_MERGED_COUNT',\n#                                   StringType(), True),\n#                     StructField('TABLE_NAME',\n#                                 StringType(), True),\n#                     StructField('DATABASE',\n#                                 StringType(), True)])\n\n# empRDD = spark.sparkContext.emptyRDD()\n\n# dffns1 = spark.createDataFrame(data = empRDD , schema = columns)\n\n# df_s_collect = dfstreamtablename.collect()\n# for row in df_s_collect:\n#     var_db = row[\"database\"]\n#     var_tn = row[\"tableName\"]\n#     dffns2 = spark.sql(f\"\"\"SELECT  COUNT(*) as TOTAL_ROW_COUNT ,(SELECT  COUNT(*) FROM {var_db}.{var_tn} WHERE date(EDA_Creation_date) = current_date()) as TODAYS_MERGED_COUNT FROM {var_db}.{var_tn}\"\"\")    \n#     dffns3 = dffns2.withColumn(\"TableName\",lit(var_tn))\n#     dffns4 = dffns3.withColumn(\"Database\",lit(var_db))\n#     dffns1 = dffns1.union(dffns4)\n# #display(dffn1)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"022ea316-08c1-40fc-9ee9-fe404278e369"},{"version":"CommandV1","origId":2709619314155013,"guid":"c9d942c0-d1ac-4a3b-a1c9-4dea167bd193","subtype":"command","commandType":"auto","position":20.0,"command":"#CREATE INDEX FOR STATS EXCEL\n\ncolumns = [\"Sr.No\",\"SHEETS\",\"DISCRIPTIONS\"]\ndata = [(\"1\", \"TotalNASrowCountPerFile\", \"Consist total row count and datafiles processed till date\"), (\"2\", \"TotalNAScountOfFilesPerTable\", \"Consist total of all datafiles per table processed till date\"), (\"3\", \"TotalNASrowPerTable\", \"Consist total rows on table level for all datafiles processed till date\"), (\"4\", \"CurrentNASrowCountPerFile\", \"Consist row count and datafiles processed for current run\"), (\"5\", \"CurrentNAScountOfFilesPerTable\", \"Consist datafiles per table processed for current run\"), (\"6\", \"CurrentNASrowPerTable\", \"Consist rows on table level for all datafiles processed for current run\"), (\"7\", \"HistoryTableStats\", \"Consist Stats related to Target History Tables\"), (\"8\", \"StreamTableStats\", \"Consist Stats related to Target Stream Tables\")]\n\ndfIndex = spark.createDataFrame(data).toDF(*columns)\ndisplay(dfIndex)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"56b325af-222c-46a3-8392-1f594649a519"},{"version":"CommandV1","origId":2709619314155014,"guid":"8bf3eae4-abde-42f2-b376-d527febcc482","subtype":"command","commandType":"auto","position":21.0,"command":"%md\n# Collect dataframes and write to excel","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"1c87c6ab-40de-4866-94da-5795ee939920"},{"version":"CommandV1","origId":2709619314155015,"guid":"581d0dac-df5b-4928-8765-7db800f29d56","subtype":"command","commandType":"auto","position":22.0,"command":"dfCatalogue = dfIndex\nCurrentNASrowCountPerFile = newDf[[\"FileName\", \"TableName\", \"Row_Count_per_file\"]]\nCurrentNAScountOfFilesPerTable = newDf2\nCurrentNASrowPerTable = newDf3\nTotalNASrowCountPerFile = newDf_tot[[\"FileName\", \"TableName\", \"Row_Count_per_file\"]]\nTotalNAScountOfFilesPerTable = newDf2_tot\nTotalNASrowPerTable = newDf3_tot\nhistoryTableStats = dffn1\n#streamTableStats = dffns1\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"914fb7b4-ffd7-4350-b125-0128e204e342"},{"version":"CommandV1","origId":2709619314155016,"guid":"8d333aa6-f7cf-4eb6-88eb-4106ca20fa73","subtype":"command","commandType":"auto","position":23.0,"command":"#import pandas as pd\nimport datetime\n\ncurrentutctime = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')\nfilenamewithtime = \"STATS_\" + currentutctime +\".xlsx\"\npartitions = datetime.datetime.now().strftime('%Y-%m-%d/')\n\nstatistics_loc_file = statistics_loc + \"/\" + partitions + filenamewithtime\n\ndfCatalogue.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'INDEX'!A1:Z20000\").save(statistics_loc_file)\nTotalNASrowCountPerFile.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'TotalNASrowCountPerFile'!A1:Z20000\").save(statistics_loc_file)\nTotalNAScountOfFilesPerTable.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'TotalNAScountOfFilesPerTable'!A1:Z20000\").save(statistics_loc_file)\nTotalNASrowPerTable.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'TotalNASrowPerTable'!A1:Z20000\").save(statistics_loc_file)\n\n\nCurrentNASrowCountPerFile.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'CurrentNASrowCountPerFile'!A1:Z20000\").save(statistics_loc_file)\nCurrentNAScountOfFilesPerTable.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'CurrentNAScountOfFilesPerTable'!A1:Z20000\").save(statistics_loc_file)\nCurrentNASrowPerTable.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'CurrentNASrowPerTable'!A1:Z20000\").save(statistics_loc_file)\nhistoryTableStats.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'HistoryTableStats'!A1:Z20000\").save(statistics_loc_file)\n#streamTableStats.write.mode(\"append\").format(\"com.crealytics.spark.excel\").option(\"header\",True).option(\"dataAddress\",\"'StreamTableStats'!A1:Z20000\").save(statistics_loc_file)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b746cb2c-13aa-4821-9012-c9fb9e760ec0"}],"dashboards":[],"guid":"f630a5a8-d436-4ae3-95a0-405d4a96e70c","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}