{"version":"NotebookV1","origId":2842915811751379,"name":"STD Data Prepartion","language":"python","commands":[{"version":"CommandV1","origId":553411872537840,"guid":"e159eb00-f2a9-4cee-9ad8-c5ffb1ac1b09","subtype":"command","commandType":"auto","position":30.0,"command":"print(f\"\"\"\n\n\n\nMERGE INTO delta.`{silver_location[1:-1]}` AS logs\nUSING newDedupedLogs AS newDedupedLogs\nON {cond}\nWHEN MATCHED AND logs.EPOCH_FLAG = 'ARCHIVE'\nTHEN UPDATE SET *\nWHEN NOT MATCHED\nTHEN INSERT *\n\"\"\")","commandVersion":3,"state":"error","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":"<span class=\"ansi-red-fg\">NameError</span>: name &#39;silver_location&#39; is not defined","errorTraceType":"html","error":"<div class=\"ansiout\"><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-green-fg\">&lt;command-553411872537840&gt;</span> in <span class=\"ansi-cyan-fg\">&lt;module&gt;</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      3</span> \n<span class=\"ansi-green-intense-fg ansi-bold\">      4</span> \n<span class=\"ansi-green-fg\">----&gt; 5</span><span class=\"ansi-red-fg\"> </span>MERGE INTO delta<span class=\"ansi-blue-fg\">.</span><span class=\"ansi-red-fg\">`</span><span class=\"ansi-blue-fg\">{</span>silver_location<span class=\"ansi-blue-fg\">[</span><span class=\"ansi-cyan-fg\">1</span><span class=\"ansi-blue-fg\">:</span><span class=\"ansi-blue-fg\">-</span><span class=\"ansi-cyan-fg\">1</span><span class=\"ansi-blue-fg\">]</span><span class=\"ansi-blue-fg\">}</span><span class=\"ansi-red-fg\">`</span> AS logs\n<span class=\"ansi-green-intense-fg ansi-bold\">      6</span> USING newDedupedLogs AS newDedupedLogs\n<span class=\"ansi-green-intense-fg ansi-bold\">      7</span> ON <span class=\"ansi-blue-fg\">{</span>cond<span class=\"ansi-blue-fg\">}</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name &#39;silver_location&#39; is not defined</div>","workflows":[],"startTime":1663758285535,"submitTime":1663758285535,"finishTime":1663758285732,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6720ea83-c3e7-4fae-9e9d-02101f0f55d4"},{"version":"CommandV1","origId":553411872537882,"guid":"cc64f13a-61ea-4f9c-9838-b471d09e452d","subtype":"command","commandType":"auto","position":31.0,"command":"spark.sql(f\"\"\"\n\n\n\nMERGE INTO delta.`{silver_location[1:-1]}` AS logs\nUSING newDedupedLogs AS newDedupedLogs\nON {cond}\nWHEN MATCHED AND logs.EPOCH_FLAG = 'ARCHIVE'\nTHEN UPDATE SET *\nWHEN NOT MATCHED\nTHEN INSERT *\n\"\"\")","commandVersion":3,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"bda5a7f6-2e85-4b54-b86e-90f1d622b545"},{"version":"CommandV1","origId":736389190656341,"guid":"c6aadc4e-c91d-48e9-841c-101c4610ab98","subtype":"command","commandType":"auto","position":30.5,"command":"#MV Alt\nfrom delta.tables import *\nfrom pyspark.sql.functions import *\nspark.conf.set(\"spark.databricks.io.cache.enabled\", \"true\")\n\nif_partitioned_table = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Partition_Key\") == 'Y').rdd.map(lambda x : x[0]).collect()\n\nif (dfifexist == False ):\n    if if_partitioned_table:\n        s = 'newDedupedLogs.limit(1).write.format(\"delta\").mode(\"overwrite\").partitionBy(\"partitioncol\").save(' + silver_location + ')'\n        exec(s)\n    else:\n        s = 'newDedupedLogs.limit(1).write.format(\"delta\").mode(\"overwrite\").save(' + silver_location + ')'\n        exec(s)","commandVersion":77,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"c2714961-ee19-4a71-999b-961041d097f9"},{"version":"CommandV1","origId":736389190656351,"guid":"ab516d7a-da5b-45c1-b065-7ab45c2a02c3","subtype":"command","commandType":"auto","position":30.25,"command":"#MV Alt\n#silver = 'abfss://dev@dtecuprodedaadl10.dfs.core.windows.net/curated/ISU_archive/silver/BCONT/'\n\ndef pathexists(path):    \n    try:\n        df = dbutils.fs.ls(path)\n        return True\n    except:\n        return False\ndfifexist =  pathexists(silver_location[1:-1])  \n\nif(dfifexist == True):\n    print(dfifexist)\nelse:\n    print(dfifexist)","commandVersion":16,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"264d4ea8-7070-4b85-9d75-1354e8903c7c"},{"version":"CommandV1","origId":2709619314156577,"guid":"250ddce3-7c2c-46f6-b6c2-501630609924","subtype":"command","commandType":"auto","position":18.5,"command":"# keyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\n# archive_df = casted_df.drop_duplicates(keyfields)","commandVersion":33,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e9b1e6ce-5ac5-4a26-95da-45dea5df03bc"},{"version":"CommandV1","origId":2842915811751380,"guid":"9df3421a-db96-40df-845e-02c05575d738","subtype":"command","commandType":"auto","position":2.0,"command":"#%run \"/EDA/Data Engineer/Framework/Secrets-Databricks-Cache\"","commandVersion":2,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663763849412,"submitTime":1663763849378,"finishTime":1663763849427,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b6cfec15-6a46-40ee-827d-28634d6df4d8"},{"version":"CommandV1","origId":2842915811751381,"guid":"5a3030fe-5b90-4d09-ab75-b088fdbf7504","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.functions import *\nfrom pyspark.sql.window import Window\nimport fnmatch","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663763849576,"submitTime":1663763849541,"finishTime":1663763849591,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e8a76b57-f3a6-45e7-b789-c7fa1acac0ed"},{"version":"CommandV1","origId":2842915811751382,"guid":"47952aac-9d33-492d-a8d0-0e8e7ed14ce3","subtype":"command","commandType":"auto","position":4.0,"command":"# Table Name\ndbutils.widgets.text(\"table_name\", \"\", \"table name\")\ntable_name = dbutils.widgets.get(\"table_name\")\n\n#SET METADATA FILEPATH in ADLS (For Example = abfss://dev@dtecuprodedaadl02.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv)\ndbutils.widgets.text(\"metafilepath\", \"\", \"METADATA FILEPATH\")\nmetafilepath = dbutils.widgets.get(\"metafilepath\")\n\n# Staging location ( source here )\ndbutils.widgets.text(\"staging_location\", \"\", \"staging location\")\nstaging_location = \"'\" + dbutils.widgets.get(\"staging_location\") + \"/\" + table_name + \"/'\"\n\n# Curated location ( destination here )\ndbutils.widgets.text(\"curated_location\", \"\", \"curated location\")\ncurated_location = \"'\" + dbutils.widgets.get(\"curated_location\") + \"/\" + table_name + \"/'\"\n\n# Silver location ( final table destination here )\ndbutils.widgets.text(\"silver_location\", \"\", \"silver location\")\nsilver_location = \"'\" + dbutils.widgets.get(\"silver_location\") + \"/\" + table_name + \"/'\"\n\n# SET DATABASE NAME\ndbutils.widgets.text(\"final_db_name\", \"\", \"FINAL DATABASE NAME\")\nfinal_db_name = dbutils.widgets.get(\"final_db_name\")\n\n# Set FULL_LOAD param with Yes/No\ndbutils.widgets.text(\"FULL_LOAD\", \"No\", \"FULL LOAD\")\nFULL_LOAD = dbutils.widgets.get(\"FULL_LOAD\")\n\n# Set DBFS log file path\ndbutils.widgets.text(\"dbfslogbasepath\", \"\", \"DBFS LOG FILE PATH\")\ndbfslogbasepath = dbutils.widgets.get(\"dbfslogbasepath\")\n","commandVersion":7,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{"curated_location":"","table_name":"","metafilepath":"","dbfslogbasepath":"","staging_location":"","silver_location":"","final_db_name":"","FULL_LOAD":"No"},"addedWidgets":{"curated_location":{"widgetType":"text","name":"curated_location","defaultValue":"","label":"curated location","options":{"widgetType":"text","validationRegex":null}},"table_name":{"widgetType":"text","name":"table_name","defaultValue":"","label":"table name","options":{"widgetType":"text","validationRegex":null}},"metafilepath":{"widgetType":"text","name":"metafilepath","defaultValue":"","label":"METADATA FILEPATH","options":{"widgetType":"text","validationRegex":null}},"dbfslogbasepath":{"widgetType":"text","name":"dbfslogbasepath","defaultValue":"","label":"DBFS LOG FILE PATH","options":{"widgetType":"text","validationRegex":null}},"staging_location":{"widgetType":"text","name":"staging_location","defaultValue":"","label":"staging location","options":{"widgetType":"text","validationRegex":null}},"silver_location":{"widgetType":"text","name":"silver_location","defaultValue":"","label":"silver location","options":{"widgetType":"text","validationRegex":null}},"final_db_name":{"widgetType":"text","name":"final_db_name","defaultValue":"","label":"FINAL DATABASE NAME","options":{"widgetType":"text","validationRegex":null}},"FULL_LOAD":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}}},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664433396998,"submitTime":1664433395333,"finishTime":1664433397029,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"0baaf449-3cf0-4a4e-ad7a-76574bd710d5"},{"version":"CommandV1","origId":2842915811751383,"guid":"aff7c8d0-30d0-42b2-8598-0e64551c2a72","subtype":"command","commandType":"auto","position":5.0,"command":"print(table_name)\nprint(metafilepath)\nprint(staging_location)\nprint(curated_location)\nprint(final_db_name)\nprint(silver_location)","commandVersion":7,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">ERDB\nbfss://dev@dtecuprodedaadl02.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv\n&#39;dbfs:/FileStore/ERDB/QI6_300_000023_IS_U_EE22_0000_ERDB_20220809_113555_0.CSV/ERDB/&#39;\n&#39;/ERDB/&#39;\n&#39;/ERDB/&#39;\n&#39;/ERDB/&#39;\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663763849822,"submitTime":1663763849788,"finishTime":1663763849837,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",275]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"fa324d7c-7da3-4375-9f65-ba2716c550a0"},{"version":"CommandV1","origId":2842915811751384,"guid":"99355e51-fbd0-4e62-9e1c-9ff981dd354c","subtype":"command","commandType":"auto","position":6.0,"command":"#START LOGGING\n\nimport logging\nimport datetime\n\n#dbfslogbasepath = \"/tmp\" + \"/\" + filenamewithtime\n\n#TAG LOGGING INFO TO NOTEBOOK\nlogger = logging.getLogger('DataPreparationNotebook')\n\n#SETTING THRESHOLD OF LOGGER TO INFO\nlogger.setLevel(logging.INFO)\n\nFilehandler = logging.FileHandler(dbfslogbasepath,mode = 'a')\n\nformatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s: %(message)s', datefmt='%m/%d/%Y %I:%M:%S %p')\nFilehandler.setFormatter(formatter)\n\nlogger.addHandler(Filehandler)\n\n#LOG INFO\nlogger.info(\"DataPreparation is Running... \")","commandVersion":1,"state":"error","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":"<span class=\"ansi-red-fg\">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/databricks/driver/dbfs:/FileStore/ERDB&#39;","errorTraceType":"html","error":"<div class=\"ansiout\"><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">FileNotFoundError</span>                         Traceback (most recent call last)\n<span class=\"ansi-green-fg\">&lt;command-2842915811751384&gt;</span> in <span class=\"ansi-cyan-fg\">&lt;module&gt;</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">     12</span> logger<span class=\"ansi-blue-fg\">.</span>setLevel<span class=\"ansi-blue-fg\">(</span>logging<span class=\"ansi-blue-fg\">.</span>INFO<span class=\"ansi-blue-fg\">)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">     13</span> \n<span class=\"ansi-green-fg\">---&gt; 14</span><span class=\"ansi-red-fg\"> </span>Filehandler <span class=\"ansi-blue-fg\">=</span> logging<span class=\"ansi-blue-fg\">.</span>FileHandler<span class=\"ansi-blue-fg\">(</span>dbfslogbasepath<span class=\"ansi-blue-fg\">,</span>mode <span class=\"ansi-blue-fg\">=</span> <span class=\"ansi-blue-fg\">&#39;a&#39;</span><span class=\"ansi-blue-fg\">)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">     15</span> \n<span class=\"ansi-green-intense-fg ansi-bold\">     16</span> formatter <span class=\"ansi-blue-fg\">=</span> logging<span class=\"ansi-blue-fg\">.</span>Formatter<span class=\"ansi-blue-fg\">(</span><span class=\"ansi-blue-fg\">&#39;%(asctime)s - %(name)s - %(levelname)s: %(message)s&#39;</span><span class=\"ansi-blue-fg\">,</span> datefmt<span class=\"ansi-blue-fg\">=</span><span class=\"ansi-blue-fg\">&#39;%m/%d/%Y %I:%M:%S %p&#39;</span><span class=\"ansi-blue-fg\">)</span>\n\n<span class=\"ansi-green-fg\">/usr/lib/python3.8/logging/__init__.py</span> in <span class=\"ansi-cyan-fg\">__init__</span><span class=\"ansi-blue-fg\">(self, filename, mode, encoding, delay)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">   1145</span>             self<span class=\"ansi-blue-fg\">.</span>stream <span class=\"ansi-blue-fg\">=</span> <span class=\"ansi-green-fg\">None</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">   1146</span>         <span class=\"ansi-green-fg\">else</span><span class=\"ansi-blue-fg\">:</span>\n<span class=\"ansi-green-fg\">-&gt; 1147</span><span class=\"ansi-red-fg\">             </span>StreamHandler<span class=\"ansi-blue-fg\">.</span>__init__<span class=\"ansi-blue-fg\">(</span>self<span class=\"ansi-blue-fg\">,</span> self<span class=\"ansi-blue-fg\">.</span>_open<span class=\"ansi-blue-fg\">(</span><span class=\"ansi-blue-fg\">)</span><span class=\"ansi-blue-fg\">)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">   1148</span> \n<span class=\"ansi-green-intense-fg ansi-bold\">   1149</span>     <span class=\"ansi-green-fg\">def</span> close<span class=\"ansi-blue-fg\">(</span>self<span class=\"ansi-blue-fg\">)</span><span class=\"ansi-blue-fg\">:</span>\n\n<span class=\"ansi-green-fg\">/usr/lib/python3.8/logging/__init__.py</span> in <span class=\"ansi-cyan-fg\">_open</span><span class=\"ansi-blue-fg\">(self)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">   1174</span>         Return the resulting stream<span class=\"ansi-blue-fg\">.</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">   1175</span>         &#34;&#34;&#34;\n<span class=\"ansi-green-fg\">-&gt; 1176</span><span class=\"ansi-red-fg\">         </span><span class=\"ansi-green-fg\">return</span> open<span class=\"ansi-blue-fg\">(</span>self<span class=\"ansi-blue-fg\">.</span>baseFilename<span class=\"ansi-blue-fg\">,</span> self<span class=\"ansi-blue-fg\">.</span>mode<span class=\"ansi-blue-fg\">,</span> encoding<span class=\"ansi-blue-fg\">=</span>self<span class=\"ansi-blue-fg\">.</span>encoding<span class=\"ansi-blue-fg\">)</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">   1177</span> \n<span class=\"ansi-green-intense-fg ansi-bold\">   1178</span>     <span class=\"ansi-green-fg\">def</span> emit<span class=\"ansi-blue-fg\">(</span>self<span class=\"ansi-blue-fg\">,</span> record<span class=\"ansi-blue-fg\">)</span><span class=\"ansi-blue-fg\">:</span>\n\n<span class=\"ansi-red-fg\">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/databricks/driver/dbfs:/FileStore/ERDB&#39;</div>","workflows":[],"startTime":1663763855473,"submitTime":1663763855473,"finishTime":1663763855566,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"75b34195-eea6-4337-912e-23efae50bd69"},{"version":"CommandV1","origId":2842915811751385,"guid":"eb3a30f4-1c18-441e-b038-0cb33a265423","subtype":"command","commandType":"auto","position":7.0,"command":"try:\n    s = 'newdf = spark.read.format(\"csv\").option(\"delimiter\", \"|\").option(\"header\",\"true\").option(\"inferSchema\",\"true\").load(' + staging_location + ')'\n    print(s)\n    exec(s)\n    logger.info(\"Reading datafiles from segregated location succeeded : refer cmd 6\")\nexcept Exception as e:\n    logger.error(\"Reading datafiles from segregated location FAILED : refer cmd 6 : \" + str(e))\n\n","commandVersion":16,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b8e98643-eff8-48c2-975a-b402763b767d"},{"version":"CommandV1","origId":2842915811751386,"guid":"5d14eb65-9350-4560-955a-a0d2761b4b23","subtype":"command","commandType":"auto","position":8.0,"command":"# FUNCTION TO CLEAN HEADER WITH PROPER COLUMN NAMES FROM DATAFRAME\n\ndef revisit_header(df=newdf,table_n=table_name):\n    if fnmatch.fnmatch(df.columns[0],table_n + \"*\") == True:\n        for i in df.columns:\n            df = df.withColumnRenamed(i, i[len(table_n)+1:])\n        print(df.columns)\n        return df\n    else:\n        return df","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"726b87fc-22bb-4a22-b541-e29d410022c7"},{"version":"CommandV1","origId":2842915811751387,"guid":"e9a1416a-6b33-4e4c-b5d6-cdc3fb81c5e9","subtype":"command","commandType":"auto","position":9.0,"command":"newdf = revisit_header()","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5f5c2135-f7c8-4f13-bd14-3721b2883a97"},{"version":"CommandV1","origId":2842915811751388,"guid":"46808cb5-4387-4ad1-8dbb-ebee450b48b2","subtype":"command","commandType":"auto","position":10.0,"command":"# display(newdf)\ncols_from_file_source = newdf.columns","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e02b2e53-d493-460f-b560-260b9add72b7"},{"version":"CommandV1","origId":2842915811751389,"guid":"149ac715-3b42-4bdb-94b9-26a103ec0314","subtype":"command","commandType":"auto","position":11.0,"command":"%run \"../Metadata/Load_Metadata\"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"98e5bc0f-bc98-48e4-8d8d-435a894ade1d"},{"version":"CommandV1","origId":2842915811751390,"guid":"3c38dd29-50b0-4131-9af5-f4e5bae42e37","subtype":"command","commandType":"auto","position":12.0,"command":"metadf = load_metadata_df(metafilepath)\n# display(metadf)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"97d0ed51-c7e4-4edf-9c1c-7b850c2a7717"},{"version":"CommandV1","origId":2842915811751391,"guid":"a5c435a2-6bcf-4b8a-b47e-e941875a182e","subtype":"command","commandType":"auto","position":13.0,"command":"cols_from_metadata = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).rdd.map(lambda x : x[0]).collect()\nprint(cols_from_metadata)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"980f4afb-f8f6-4446-ae0e-15445895ec97"},{"version":"CommandV1","origId":2842915811751392,"guid":"7f758227-795a-4b53-8b15-4f3cdc55e666","subtype":"command","commandType":"auto","position":14.0,"command":"print(cols_from_file_source)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a1ceab8e-cbf0-4841-9319-12fb498857dd"},{"version":"CommandV1","origId":2842915811751394,"guid":"8dc33420-95a3-4e73-a9ac-f9862ddedef0","subtype":"command","commandType":"auto","position":16.0,"command":"def generate_code_for_casting_columns_based_on_metadata(metadf,table_name,dfname,newdfname):\n  z = str(\"\")\n  cols = metadf.select(\"Field_Name\",\"delta_types\").where(col(\"Table_Name\")==table_name).rdd.map(lambda x : x[0]).collect()\n  col_types = metadf.select(\"Field_Name\",\"delta_types\").where(col(\"Table_Name\")==table_name).rdd.map(lambda x : x[1]).collect()\n  for i,j in zip(cols,col_types):\n    i = '\"' + i + '\"'\n    j = '\"' + j + '\"'\n    z = z + ('.withColumn(' + i + ',col(' + i + ').cast(' + j + '))')\n  return(newdfname + ' = ' + dfname + z)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"05285c8b-03bc-400e-ae52-867aa50365c6"},{"version":"CommandV1","origId":2842915811751395,"guid":"eecfe1a8-7741-440e-9c77-42dd8b9219ff","subtype":"command","commandType":"auto","position":17.0,"command":"try:\n    get_code = generate_code_for_casting_columns_based_on_metadata(metadf,table_name,'newdf','casted_df')\n    exec(get_code)\n    print(get_code)\n    logger.info(\"generate_code_for_casting_columns_based_on_metadata function succeeded : refer cmd 16\")\nexcept Exception as e:\n    logger.error(\"generate_code_for_casting_columns_based_on_metadata function FAILED : refer cmd 16 : \" + str(e))\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"53ea594a-b0d9-46c3-9c75-7de2f0b6203a"},{"version":"CommandV1","origId":2842915811751398,"guid":"2093a7dc-6d6f-4a6f-9ae8-0052a75e8518","subtype":"command","commandType":"auto","position":20.0,"command":"def generate_code_for_adding_flag_columns(metadf,table_name,dfname,newdfname):\n    col1 = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Partition_Key\") == 'Y').rdd.map(lambda x : x[0]).collect()\n    if col1:\n        Logic_1 = newdfname + \" = \" + dfname + \".withColumn('partitioncol',lit('ARCHIVE')).withColumn('EPOCH_FLAG',lit('ARCHIVE'))\"\n    else:\n        Logic_1 = newdfname + \" = \" + dfname + \".withColumn('EPOCH_FLAG',lit('ARCHIVE'))\"\n    return(Logic_1)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"76b805e7-012c-4ea5-bc09-62192648f337"},{"version":"CommandV1","origId":2842915811751399,"guid":"4c1802b3-d947-496b-8e3f-7a74dda6cae6","subtype":"command","commandType":"auto","position":21.0,"command":"# GENERATE SCHEMA FOR ARCHIVE MAIN TABLE\n\ntry:\n    get_code = generate_code_for_adding_flag_columns(metadf,table_name,'archive_df','archive_part_col_added_df')\n    print(get_code)\n    exec(get_code)\n    logger.info(\"Generate Schema for Archive Main Table succeeded : refer cmd 20\")\nexcept Exception as e:\n    logger.error(\"Generate Schema for Archive Main Table FAILED : refer cmd 20 : \" + str(e))\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cd03c9dd-2b0d-4107-8e59-18c50cc2fb0d"},{"version":"CommandV1","origId":2842915811751401,"guid":"236c1a0c-2e95-41a1-bce7-920b4eb44ad1","subtype":"command","commandType":"auto","position":23.0,"command":"archive_final_DF = archive_part_col_added_df.withColumn(\"EDA_Creation_date\",current_timestamp())","commandVersion":2,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"eef49ff5-e6e3-487f-9897-cdff70de591f"},{"version":"CommandV1","origId":2842915811751403,"guid":"d94feae0-2ceb-4f86-9648-84ca92d834e3","subtype":"command","commandType":"auto","position":25.0,"command":"archive_write_DF = archive_final_DF.drop(\"row_number\")","commandVersion":5,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"18f495ac-5c2e-4e84-b15f-9e0664eca14a"},{"version":"CommandV1","origId":2842915811751404,"guid":"7977337f-8f4f-4bbf-80ca-6a7f81b1abee","subtype":"command","commandType":"auto","position":26.0,"command":"from delta.tables import *\nfrom pyspark.sql.functions import *","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"174ab3c0-46fe-4754-9bba-e6049123817e"},{"version":"CommandV1","origId":2842915811751405,"guid":"c8210bde-76a0-479c-9e1d-8f34b38f9527","subtype":"command","commandType":"auto","position":27.0,"command":"# IF FULL_LOAD = Yes, OVERWRITE FILES/FOLDER IN TARGET LOCATION ELSE PERFORM MERGE \n\ntry:    \n    if (str(FULL_LOAD) == 'Yes'):\n        dbutils.fs.rm(curated_location[1:-1],True)\n        #dbutils.fs.rm(curated_location_err,True)\n        spark.sql(f\"\"\" DELETE FROM {final_db_name}.{table_name} WHERE EPOCH_FLAG = 'ARCHIVE' \"\"\")\n        s = 'archive_write_DF.limit(1).write.format(\"delta\").mode(\"overwrite\").save(' + curated_location + ')'\n        exec(s)\n#         s = 'erroneous_write_DF.write.format(\"delta\").mode(\"overwrite\").save(' + curated_location_err + ')'\n#         exec(s)\n    \n    keyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\n    cond = ''\n    exitindex = len(keyfields)-1\n    for i in keyfields:\n        if keyfields.index(i) == exitindex:\n            cond = cond + 'trim(cast(logs.' + i + ' as string)) = trim(cast(newDedupedLogs.' + i + ' as string))'\n        else:\n            cond = cond + 'trim(cast(logs.' + i + ' as string)) = trim(cast(newDedupedLogs.' + i + ' as string))' + ' AND '\n\n    print(cond)\n\n\n    s = \"deltaTable = DeltaTable.forPath(spark, \" + curated_location + \")\"\n    exec(s)\n    newDedupedLogs = archive_write_DF\n\n    deltaTable.alias(\"logs\").merge(\n        newDedupedLogs.alias(\"newDedupedLogs\"),\n        cond) \\\n      .whenMatchedUpdateAll() \\\n      .whenNotMatchedInsertAll() \\\n      .execute()\nexcept Exception as e:\n    logger.error(\"MERGE FAILED : refer cmd 26 : \" + str(e))","commandVersion":85,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"be1e567d-cb4a-4069-83a6-1808d6084785"},{"version":"CommandV1","origId":2842915811751406,"guid":"df88a5a1-7f98-45b6-b0cd-e55c13b51092","subtype":"command","commandType":"auto","position":28.0,"command":"# Merge data to Final table\n\nkeyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\ncond = ''\nexitindex = len(keyfields)-1\nfor i in keyfields:\n    if keyfields.index(i) == exitindex:\n        cond = cond + 'trim(cast(logs.' + i + ' as string)) = trim(cast(newDedupedLogs.' + i + ' as string))'\n    else:\n        cond = cond + 'trim(cast(logs.' + i + ' as string)) = trim(cast(newDedupedLogs.' + i + ' as string))' + ' AND '\n        \nprint(cond)\n\nnewDedupedLogs = archive_write_DF\nnewDedupedLogs.createOrReplaceTempView(\"newDedupedLogs\")\n","commandVersion":23,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"newDedupedLogs","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"MANDT","nullable":true,"type":"string"},{"metadata":{},"name":"LAUFD","nullable":true,"type":"string"},{"metadata":{},"name":"LAUFI","nullable":true,"type":"string"},{"metadata":{},"name":"GPART","nullable":true,"type":"string"},{"metadata":{},"name":"VKONT","nullable":true,"type":"string"},{"metadata":{},"name":"MAZAE","nullable":true,"type":"string"},{"metadata":{},"name":"AKZAE","nullable":true,"type":"string"},{"metadata":{},"name":"ATEXT","nullable":true,"type":"string"},{"metadata":{},"name":"TABNAME","nullable":true,"type":"string"},{"metadata":{},"name":"TABKEY","nullable":true,"type":"string"},{"metadata":{},"name":"DISCNO","nullable":true,"type":"string"},{"metadata":{},"name":"XFILE","nullable":true,"type":"string"},{"metadata":{},"name":"partitioncol","nullable":true,"type":"string"},{"metadata":{},"name":"EPOCH_FLAG","nullable":true,"type":"string"},{"metadata":{},"name":"EDA_Creation_date","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663750168104,"submitTime":1663750168044,"finishTime":1663750168127,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7d3accf9-056f-43c4-939f-9b0c66722c11"},{"version":"CommandV1","origId":3247594356429521,"guid":"0a5fe147-6a22-4335-ad10-70a155333613","subtype":"command","commandType":"auto","position":19.25,"command":"print(keyfields)","commandVersion":13,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"fb540ad2-a3fc-48ec-974f-cd0e1858adc1"},{"version":"CommandV1","origId":3247594356429669,"guid":"5cf22efa-c8b0-4203-87c6-c8480743d39f","subtype":"command","commandType":"auto","position":18.875,"command":"keyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\n\ncasted_df2 = casted_df.na.drop(how='any', subset = keyfields)\nprint(casted_df2.count())\n\narchive_df = casted_df2.drop_duplicates(keyfields)\nprint(archive_df.count())","commandVersion":22,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6174ba83-d354-459f-a49a-475f8126bc28"},{"version":"CommandV1","origId":3247594356429730,"guid":"a2dc31fd-73b0-4b73-9843-c30a07333a4e","subtype":"command","commandType":"auto","position":18.6875,"command":"casted_df.count()","commandVersion":3,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e8aebbe1-4945-40a0-a34e-182f4ef8d57b"},{"version":"CommandV1","origId":4441117762638479,"guid":"34355eac-1b24-4c12-a69d-1dbe22b1b4e0","subtype":"command","commandType":"auto","position":29.5,"command":"%sql\n\nSelect count(*) from newDedupedLogs","commandVersion":10,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"f04ae720-5e21-4da3-ab9d-de1c903a1b08"}],"dashboards":[],"guid":"1ef000b0-4b97-436a-9736-1b9fa43ef42a","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"curated_location":{"nuid":"40e2e5ea-20d0-4549-aeb8-cc0afe8beba0","currentValue":"","widgetInfo":{"widgetType":"text","name":"curated_location","defaultValue":"","label":"curated location","options":{"widgetType":"text","validationRegex":null}}},"table_name":{"nuid":"482cde28-0b5c-4356-ae2f-67f32a2f6f96","currentValue":"","widgetInfo":{"widgetType":"text","name":"table_name","defaultValue":"","label":"table name","options":{"widgetType":"text","validationRegex":null}}},"metafilepath":{"nuid":"5638f1b1-4590-4d1d-80d4-7b7103c79fcb","currentValue":"","widgetInfo":{"widgetType":"text","name":"metafilepath","defaultValue":"","label":"METADATA FILEPATH","options":{"widgetType":"text","validationRegex":null}}},"dbfslogbasepath":{"nuid":"5da80f45-04fe-4fae-aed1-b676751802a2","currentValue":"","widgetInfo":{"widgetType":"text","name":"dbfslogbasepath","defaultValue":"","label":"DBFS LOG FILE PATH","options":{"widgetType":"text","validationRegex":null}}},"staging_location":{"nuid":"bd3fba4e-3883-4bfa-be9d-9722d94597b6","currentValue":"","widgetInfo":{"widgetType":"text","name":"staging_location","defaultValue":"","label":"staging location","options":{"widgetType":"text","validationRegex":null}}},"curated_location_err":{"nuid":"3eaeb54e-a630-4701-a879-a981f6500a31","currentValue":"","widgetInfo":{"widgetType":"text","name":"curated_location_err","defaultValue":"","label":"curated location for error table","options":{"widgetType":"text","validationRegex":null}}},"silver_location":{"nuid":"28e57d4c-513d-49f0-bdd7-53f2f743d062","currentValue":"","widgetInfo":{"widgetType":"text","name":"silver_location","defaultValue":"","label":"silver location","options":{"widgetType":"text","validationRegex":null}}},"final_db_name":{"nuid":"8d40f448-a484-483a-9586-73fdc004270d","currentValue":"","widgetInfo":{"widgetType":"text","name":"final_db_name","defaultValue":"","label":"FINAL DATABASE NAME","options":{"widgetType":"text","validationRegex":null}}},"FULL_LOAD":{"nuid":"3a4b4075-5406-4186-ab14-55ac68c9ad36","currentValue":"No","widgetInfo":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}