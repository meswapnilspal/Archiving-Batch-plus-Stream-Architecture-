{"version":"NotebookV1","origId":2842915811751346,"name":"STD NAS_data_file_movement","language":"python","commands":[{"version":"CommandV1","origId":2842915811751347,"guid":"f45eb91e-e2a0-4ff6-995a-3fc01a7de861","subtype":"command","commandType":"auto","position":2.0,"command":"#%run \"/EDA/Data Engineer/Framework/Secrets-Databricks-Cache\"","commandVersion":2,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"63e4a20d-ab36-4458-b7bb-279b2aaad4aa"},{"version":"CommandV1","origId":2842915811751348,"guid":"b091a14f-f32c-4613-b303-d73de0a3f5a1","subtype":"command","commandType":"auto","position":3.0,"command":"# SET LOAD TYPE (FULL LOAD = Yes/No)\ndbutils.widgets.text(\"FULL_LOAD\", \"No\", \"FULL LOAD\")\nFULL_LOAD = dbutils.widgets.get(\"FULL_LOAD\")\n\n# SET ENVIRONMENT FOR DATA LAKE (02 OR 10 OR etc)\ndbutils.widgets.text(\"env\", \"02\", \"ADLS ENVIRONMENT\")\nenv = dbutils.widgets.get(\"env\")\n\n#SET BASE PATH\nbasepath = 'abfss://dev@dtecuprodedaadl' + env + '.dfs.core.windows.net/'\n\n#SET STG BACKUP LOCATION\ndbutils.widgets.text(\"staging_backup_loc\", \"raw/ISU_archive/staging_backup\", \"STAGING BACKUP LOC\")\nstaging_backup_loc = basepath + dbutils.widgets.get(\"staging_backup_loc\")\n\n#SET STG LOCATION\ndbutils.widgets.text(\"staging_loc\", \"raw/ISU_archive/staging\", \"STAGING LOC\")\nstaging_loc = basepath + dbutils.widgets.get(\"staging_loc\")\n\n#SET STG COLLECTED LOCATION\ndbutils.widgets.text(\"staging_collected_loc\", \"raw/ISU_archive/staging_collected\", \"STAGING COLLECTED LOC\")\nstaging_collected_loc = basepath + dbutils.widgets.get(\"staging_collected_loc\")\n\n#SET EXTRAS LOCATION\ndbutils.widgets.text(\"extras_loc\", \"raw/ISU_archive/extras\", \"EXTRAS LOC\")\nextras_loc = basepath + dbutils.widgets.get(\"extras_loc\")\n\n#SET SEGREGATED LOCATION\ndbutils.widgets.text(\"segregated_loc\", \"raw/ISU_archive/segregated\", \"SEGREGATED LOC\")\nsegregated_loc = basepath + dbutils.widgets.get(\"segregated_loc\")\n\n#SET METADATA FILEPATH FROM ADLS (For example  = ISU_archive_support/metadata/Final_metadata.csv)\ndbutils.widgets.text(\"metaadlspath\", \"ISU_archive_support/metadata/Final_metadata.csv\", \"METADATA FILE LOC\")\nmetaadlspath = dbutils.widgets.get(\"metaadlspath\")\n\n#SET METADATA FILE FULL PATH TO ADLS\nmetafilepath = basepath + metaadlspath\n\n#SET EXECUTION LOGS LOCATION PATH \ndbutils.widgets.text(\"execution_logs_loc\", \"ISU_archive_support/execution_logs/nas_logs\", \"EXECUTION LOGS LOC\")\nexecution_logs_loc = basepath + dbutils.widgets.get(\"execution_logs_loc\")\n","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{"execution_logs_loc":"ISU_archive_support/execution_logs/nas_logs","staging_loc":"raw/ISU_archive/staging","extras_loc":"raw/ISU_archive/extras","staging_collected_loc":"raw/ISU_archive/staging_collected","staging_backup_loc":"raw/ISU_archive/staging_backup","metaadlspath":"ISU_archive_support/metadata/Final_metadata.csv","FULL_LOAD":"No","segregated_loc":"raw/ISU_archive/segregated","env":"02"},"addedWidgets":{"execution_logs_loc":{"widgetType":"text","name":"execution_logs_loc","defaultValue":"ISU_archive_support/execution_logs/nas_logs","label":"EXECUTION LOGS LOC","options":{"widgetType":"text","validationRegex":null}},"staging_loc":{"widgetType":"text","name":"staging_loc","defaultValue":"raw/ISU_archive/staging","label":"STAGING LOC","options":{"widgetType":"text","validationRegex":null}},"extras_loc":{"widgetType":"text","name":"extras_loc","defaultValue":"raw/ISU_archive/extras","label":"EXTRAS LOC","options":{"widgetType":"text","validationRegex":null}},"staging_collected_loc":{"widgetType":"text","name":"staging_collected_loc","defaultValue":"raw/ISU_archive/staging_collected","label":"STAGING COLLECTED LOC","options":{"widgetType":"text","validationRegex":null}},"staging_backup_loc":{"widgetType":"text","name":"staging_backup_loc","defaultValue":"raw/ISU_archive/staging_backup","label":"STAGING BACKUP LOC","options":{"widgetType":"text","validationRegex":null}},"metaadlspath":{"widgetType":"text","name":"metaadlspath","defaultValue":"ISU_archive_support/metadata/Final_metadata.csv","label":"METADATA FILE LOC","options":{"widgetType":"text","validationRegex":null}},"FULL_LOAD":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}},"segregated_loc":{"widgetType":"text","name":"segregated_loc","defaultValue":"raw/ISU_archive/segregated","label":"SEGREGATED LOC","options":{"widgetType":"text","validationRegex":null}},"env":{"widgetType":"text","name":"env","defaultValue":"02","label":"ADLS ENVIRONMENT","options":{"widgetType":"text","validationRegex":null}}},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663766278710,"submitTime":1663766278643,"finishTime":1663766278737,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"21cda1eb-335c-442c-9433-c328faae67b3"},{"version":"CommandV1","origId":2842915811751349,"guid":"faa5e9b9-a8e4-4fa9-8c84-8a2124b34a76","subtype":"command","commandType":"auto","position":4.0,"command":"print(\"FULL_LOAD : \" + FULL_LOAD)\nprint(\"basepath : \" + basepath)\nprint(\"staging_backup_loc : \" + staging_backup_loc)\nprint(\"staging_loc : \" + staging_loc)\nprint(\"staging_collected_loc : \" + staging_collected_loc)\nprint(\"extras_loc : \" + extras_loc)\nprint(\"segregated_loc : \" + segregated_loc)\nprint(\"metafilepath : \" + metafilepath)\nprint(\"execution_logs_loc : \" + execution_logs_loc)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"f015a4d7-6cad-4f45-9f48-7ea478275c40"},{"version":"CommandV1","origId":2842915811751350,"guid":"ec44e887-2e68-4b85-a8cb-dfb83a961476","subtype":"command","commandType":"auto","position":5.0,"command":"#START LOGGING\n\nimport logging\nimport datetime\n\nexecution_logs_loc2 = execution_logs_loc + \"/\"\n\n#ADD FOLDER IF NOT EXIST\ndbutils.fs.mkdirs(execution_logs_loc)\n\ncurrentutctime = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')\nfilenamewithtime = \"EDA_NAS_\" + currentutctime +\".log\"\npartitions = datetime.datetime.now().strftime('%Y-%m-%d/')\n\ndbfslogbasepath = \"/tmp\" + \"/\" + filenamewithtime\n\n#TAG LOGGING INFO TO NOTEBOOK\nlogger = logging.getLogger('NASDataMovement')\n\n#SETTING THRESHOLD OF LOGGER TO INFO\nlogger.setLevel(logging.INFO)\n\nFilehandler = logging.FileHandler(dbfslogbasepath,mode = 'a')\n\nformatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s: %(message)s', datefmt='%m/%d/%Y %I:%M:%S %p')\nFilehandler.setFormatter(formatter)\n\nlogger.addHandler(Filehandler)\n\n#LOG INFO\nlogger.info(\"NAS file movement NoteBook run started \")\nlogger.info(\"Input Parameters >>\")\nlogger.info(\"basepath : \" + basepath + \",\" + \"FULL_LOAD : \" + FULL_LOAD + \",\" + \"staging_backup_loc : \" + staging_backup_loc + \",\" + \"staging_loc : \" + staging_loc + \",\" + \"staging_collected_loc : \" + staging_collected_loc + \",\" + \"extras_loc : \" + extras_loc + \",\" + \"segregated_loc : \" + segregated_loc + \",\" + \"metafilepath : \" + metafilepath + \",\" + \"execution_logs_loc : \" + execution_logs_loc)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"4521698b-e894-403c-a853-635e88435906"},{"version":"CommandV1","origId":2842915811751351,"guid":"88a70659-7b69-45ef-aad5-d421fc095a7a","subtype":"command","commandType":"auto","position":6.0,"command":"dbutils.fs.mkdirs(staging_backup_loc)\nlogger.info(\"Created staging_backup_loc directory : refer cmd 5\")\ndbutils.fs.mkdirs(staging_loc)\nlogger.info(\"Created staging_loc directory : refer cmd 5\")\ndbutils.fs.mkdirs(extras_loc)\nlogger.info(\"Created extras_loc directory : refer cmd 5\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"842e9079-879a-4adb-bd14-8d2a9d9ddfc0"},{"version":"CommandV1","origId":2842915811751352,"guid":"9368c2b7-0c85-45ef-9b76-151e7b90e936","subtype":"command","commandType":"auto","position":7.0,"command":"dbutils.fs.rm(segregated_loc, True)\nlogger.info(\"Removed segregated_loc directory : refer cmd 6\")\ndbutils.fs.rm(staging_backup_loc, True)\nlogger.info(\"Removed staging_backup_loc directory : refer cmd 6\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"95c494da-c9d9-44c7-8344-77076bb21985"},{"version":"CommandV1","origId":2842915811751353,"guid":"2eebd69b-a6aa-422c-9a32-f9cdae4246d2","subtype":"command","commandType":"auto","position":8.0,"command":"dbutils.fs.cp(staging_loc, staging_backup_loc, True)\nlogger.info(\"Copied  staging_loc to staging_backup_loc directory\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"99b9d5d5-8ae8-4d1b-a649-4e91b9d872c5"},{"version":"CommandV1","origId":2842915811751354,"guid":"fdc34caa-65b0-47c6-8e3f-6c40413c814d","subtype":"command","commandType":"auto","position":9.0,"command":"dbutils.fs.cp(staging_loc, staging_collected_loc, True)\nlogger.info(\"Copied  staging_loc to staging_collected_loc directory\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"299b3df7-8303-43a6-aec4-ccb517a4e4d6"},{"version":"CommandV1","origId":2842915811751355,"guid":"9093a1ec-3e6e-4409-9886-cd4a78781ab5","subtype":"command","commandType":"auto","position":10.0,"command":"%run \"../Metadata/Load_Metadata\"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"f2ed0ea8-6669-423b-a523-e50abcba5fa8"},{"version":"CommandV1","origId":2842915811751356,"guid":"6bf77d8d-6e14-4792-8043-5d1aacb562fe","subtype":"command","commandType":"auto","position":11.0,"command":"metadf = load_metadata_df(metafilepath)\ndisplay(metadf)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"55f46907-ba16-4961-8b75-e131dfed5431"},{"version":"CommandV1","origId":2842915811751357,"guid":"cfa7a61a-daf6-48cc-b498-b7c739202386","subtype":"command","commandType":"auto","position":12.0,"command":"tablelist = metadf.select(\"Table_Name\").distinct().rdd.map(lambda x : x[0]).collect()\nprint(tablelist)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"835a9599-5e5f-4412-95bf-eb4c02118905"},{"version":"CommandV1","origId":2842915811751358,"guid":"8ebfe611-304d-41a1-874c-99843cf5b2ba","subtype":"command","commandType":"auto","position":13.0,"command":"if FULL_LOAD == 'Yes':\n  stagingloc = staging_collected_loc\nelse:\n  stagingloc = staging_loc\n\n\nsegregatedloc = segregated_loc\nextrasloc = extras_loc\n\nfileloc = dbutils.fs.ls(stagingloc)\nfilelist = list(map(lambda p: p.name, fileloc))","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"fba2096a-b5e7-4e03-b28e-d089f0020539"},{"version":"CommandV1","origId":2842915811751359,"guid":"15063ff3-a6dc-4d89-8724-0a9166e44ba3","subtype":"command","commandType":"auto","position":14.0,"command":"def grab_files_for_a_table(table,file_list,stagingloc,segregatedloc):\n  matchphrase = '#' + table + '#'\n  tables_with_data = ''\n  filelistreq = [i for i in file_list if any(i for j in [matchphrase] if str(j) in i)]\n  len(filelistreq)\n  if filelistreq:\n    tables_with_data = table\n    for x in filelistreq:\n      #print(stagingloc + '/' + x, segregatedloc + '/' + table + '/' + x)\n      dbutils.fs.cp(stagingloc + '/' + str(x), segregatedloc + '/' + table + '/' + str(x))          \n    return(filelistreq,tables_with_data)\n  else:\n    return(filelistreq,tables_with_data)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"f17ef939-4df8-459a-9419-a54f4c0acd47"},{"version":"CommandV1","origId":2842915811751360,"guid":"e9686b1a-55d9-44fc-8efa-88d014eb897e","subtype":"command","commandType":"auto","position":15.0,"command":"try:  \n  alldatafiles = []\n  tablelist_with_data = []\n  for y in tablelist:\n    filelistreq,with_data = grab_files_for_a_table(y,filelist,stagingloc,segregatedloc)\n    alldatafiles = alldatafiles + filelistreq\n    tablelist_with_data = tablelist_with_data + [with_data]\n  \n  print(tablelist_with_data)\n  logger.info(\"Files copied from staging to segregated location : refer cmd 14 and 13\")\nexcept Exception as e:\n  logger.error(\"grab_files_for_a_table function failed while executing : refer cmd 14 and 13 : \" + str(e))\n  dbutils.fs.mv(\"file:\" + dbfslogbasepath,execution_logs_loc2 + partitions + filenamewithtime)\n  ","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"52df60ee-0e92-4789-b7fd-73533d6e57b2"},{"version":"CommandV1","origId":2842915811751361,"guid":"6670ece0-ffbb-4861-a35f-f2e8d4753a5e","subtype":"command","commandType":"auto","position":16.0,"command":"extrafiles = [item for item in filelist if item not in alldatafiles]\nlen(extrafiles)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5784bd45-76bd-4f2e-b291-2e41dae1d44f"},{"version":"CommandV1","origId":2842915811751362,"guid":"b5b6fbdd-38bf-4a3b-ad50-ba659ff3a38b","subtype":"command","commandType":"auto","position":17.0,"command":"extrafiles","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e1255df7-1747-456e-8f96-b7867ce7c439"},{"version":"CommandV1","origId":2842915811751363,"guid":"883ccbb7-1d8c-4a8f-9e92-447f6313ead4","subtype":"command","commandType":"auto","position":18.0,"command":"# Copy extra files\nfor x in extrafiles:\n  dbutils.fs.cp(stagingloc + '/' + x, extrasloc + '/' + x)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6fae9d54-2bd6-4e02-ae1b-bae395dcf441"},{"version":"CommandV1","origId":2842915811751364,"guid":"b4c5e919-5f39-4e0c-9a14-e9e7b6d21709","subtype":"command","commandType":"auto","position":19.0,"command":"tablelist_with_data = [x for x in tablelist_with_data if x]\nprint(len(tablelist_with_data))\nprint(tablelist_with_data)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"27ee0691-12f4-4670-be21-33f7a5f422f2"},{"version":"CommandV1","origId":2842915811751365,"guid":"4445d808-65ef-414c-9fe8-5114db06fd10","subtype":"command","commandType":"auto","position":20.0,"command":"dbutils.fs.rm(staging_loc, True)\nlogger.info(\"Staging location removed!\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cc110b51-71f8-4d46-b8ff-9c35a47bfae7"},{"version":"CommandV1","origId":2842915811751366,"guid":"862ff0af-4755-4c3a-b8a4-dfad927eb381","subtype":"command","commandType":"auto","position":21.0,"command":"#LOG INFO\nlogger.info(\"NAS data load Completed Successfully!\")\n\n#MOVE LOG FILE TO ADLS LOCATION\ndbutils.fs.mv(\"file:\" + dbfslogbasepath,execution_logs_loc2 + partitions + filenamewithtime)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"47fce8d7-0fb7-487d-ba68-bdceb72a1db9"}],"dashboards":[],"guid":"c1c37c21-6d3b-409e-81d2-b0e9eea01086","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"execution_logs_loc":{"nuid":"1e3c8438-c332-4407-a324-e2480a975df2","currentValue":"ISU_archive_support/execution_logs/nas_logs","widgetInfo":{"widgetType":"text","name":"execution_logs_loc","defaultValue":"ISU_archive_support/execution_logs/nas_logs","label":"EXECUTION LOGS LOC","options":{"widgetType":"text","validationRegex":null}}},"staging_loc":{"nuid":"2d5eee18-36ee-4320-b960-8a3b4ce6735f","currentValue":"raw/ISU_archive/staging","widgetInfo":{"widgetType":"text","name":"staging_loc","defaultValue":"raw/ISU_archive/staging","label":"STAGING LOC","options":{"widgetType":"text","validationRegex":null}}},"extras_loc":{"nuid":"2c9b0d3e-8675-454b-abc8-f3a87278f7ea","currentValue":"raw/ISU_archive/extras","widgetInfo":{"widgetType":"text","name":"extras_loc","defaultValue":"raw/ISU_archive/extras","label":"EXTRAS LOC","options":{"widgetType":"text","validationRegex":null}}},"staging_collected_loc":{"nuid":"62af5b50-384f-47c7-843d-2bbd80e53022","currentValue":"raw/ISU_archive/staging_collected","widgetInfo":{"widgetType":"text","name":"staging_collected_loc","defaultValue":"raw/ISU_archive/staging_collected","label":"STAGING COLLECTED LOC","options":{"widgetType":"text","validationRegex":null}}},"staging_backup_loc":{"nuid":"824eea57-2637-4e61-aa04-e99756bea583","currentValue":"raw/ISU_archive/staging_backup","widgetInfo":{"widgetType":"text","name":"staging_backup_loc","defaultValue":"raw/ISU_archive/staging_backup","label":"STAGING BACKUP LOC","options":{"widgetType":"text","validationRegex":null}}},"metaadlspath":{"nuid":"d9f19c5d-680a-46fb-9f99-afc2e256e5b1","currentValue":"ISU_archive_support/metadata/Final_metadata.csv","widgetInfo":{"widgetType":"text","name":"metaadlspath","defaultValue":"ISU_archive_support/metadata/Final_metadata.csv","label":"METADATA FILE LOC","options":{"widgetType":"text","validationRegex":null}}},"FULL_LOAD":{"nuid":"c7703857-4e87-4480-8a8b-23e2ddd49ad2","currentValue":"No","widgetInfo":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}}},"segregated_loc":{"nuid":"db3f344a-4e2b-45f5-9f63-84cc97a40395","currentValue":"raw/ISU_archive/segregated","widgetInfo":{"widgetType":"text","name":"segregated_loc","defaultValue":"raw/ISU_archive/segregated","label":"SEGREGATED LOC","options":{"widgetType":"text","validationRegex":null}}},"env":{"nuid":"7b045605-a9dd-4b4e-a6a1-ab478fbba873","currentValue":"02","widgetInfo":{"widgetType":"text","name":"env","defaultValue":"02","label":"ADLS ENVIRONMENT","options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}