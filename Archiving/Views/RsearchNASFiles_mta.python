{"version":"NotebookV1","origId":2709619314156546,"name":"RsearchNASFiles_mta","language":"python","commands":[{"version":"CommandV1","origId":2709619314156547,"guid":"c9350c0b-7993-4f04-a35d-e8cb4008dcb5","subtype":"command","commandType":"auto","position":2.0,"command":"#%run \"/EDA/Data Engineer/Framework/Secrets-Databricks-Cache\"","commandVersion":2,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663764817321,"submitTime":1663764816168,"finishTime":1663764817341,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b6cfec15-6a46-40ee-827d-28634d6df4d8"},{"version":"CommandV1","origId":2709619314156548,"guid":"08c67bf1-ba5c-4934-b2dc-c48f972015bd","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.functions import *\nfrom pyspark.sql.window import Window\nimport fnmatch","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663764817344,"submitTime":1663764816323,"finishTime":1663764817366,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e8a76b57-f3a6-45e7-b789-c7fa1acac0ed"},{"version":"CommandV1","origId":2709619314156549,"guid":"6da639d9-eac6-4c05-be9b-cbe042fdfa5a","subtype":"command","commandType":"auto","position":4.0,"command":"# Table Name\ndbutils.widgets.text(\"table_name\", \"\", \"table name\")\ntable_name = dbutils.widgets.get(\"table_name\")\n\n#SET METADATA FILEPATH in ADLS (For Example = abfss://dev@dtecuprodedaadl02.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv)\ndbutils.widgets.text(\"metafilepath\", \"\", \"METADATA FILEPATH\")\nmetafilepath = dbutils.widgets.get(\"metafilepath\")\n\n# Staging location ( source here )\ndbutils.widgets.text(\"staging_location\", \"\", \"staging location\")\nstaging_location = \"'\" + dbutils.widgets.get(\"staging_location\") + \"/\" + table_name + \"/'\"\n\n# Curated location ( destination here )\ndbutils.widgets.text(\"curated_location\", \"\", \"curated location\")\ncurated_location = \"'\" + dbutils.widgets.get(\"curated_location\") + \"/\" + table_name + \"/'\"\n\n# Silver location ( final table destination here )\ndbutils.widgets.text(\"silver_location\", \"\", \"silver location\")\nsilver_location = \"'\" + dbutils.widgets.get(\"silver_location\") + \"/\" + table_name + \"/'\"\n\n# Curated location for Error Table\ndbutils.widgets.text(\"curated_location_err\", \"\", \"curated location for error table\")\ncurated_location_err = \"'\" + dbutils.widgets.get(\"curated_location_err\") + \"/\" + table_name + \"/'\"\n\n# Set FULL_LOAD param with Yes/No\ndbutils.widgets.text(\"FULL_LOAD\", \"No\", \"FULL LOAD\")\nFULL_LOAD = dbutils.widgets.get(\"FULL_LOAD\")\n\n# Set DBFS log file path\ndbutils.widgets.text(\"dbfslogbasepath\", \"\", \"DBFS LOG FILE PATH\")\ndbfslogbasepath = dbutils.widgets.get(\"dbfslogbasepath\")\n","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{"curated_location":"","table_name":"ERDB","metafilepath":"bfss://dev@dtecuprodedaadl02.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv","dbfslogbasepath":"dbfs:/FileStore/ERDB","staging_location":"dbfs:/FileStore/ERDB/QI6_300_000023_IS_U_EE22_0000_ERDB_20220809_113555_0.CSV","curated_location_err":"","silver_location":"","FULL_LOAD":"No"},"addedWidgets":{"curated_location":{"widgetType":"text","name":"curated_location","defaultValue":"","label":"curated location","options":{"widgetType":"text","validationRegex":null}},"table_name":{"widgetType":"text","name":"table_name","defaultValue":"","label":"table name","options":{"widgetType":"text","validationRegex":null}},"metafilepath":{"widgetType":"text","name":"metafilepath","defaultValue":"","label":"METADATA FILEPATH","options":{"widgetType":"text","validationRegex":null}},"dbfslogbasepath":{"widgetType":"text","name":"dbfslogbasepath","defaultValue":"","label":"DBFS LOG FILE PATH","options":{"widgetType":"text","validationRegex":null}},"staging_location":{"widgetType":"text","name":"staging_location","defaultValue":"","label":"staging location","options":{"widgetType":"text","validationRegex":null}},"curated_location_err":{"widgetType":"text","name":"curated_location_err","defaultValue":"","label":"curated location for error table","options":{"widgetType":"text","validationRegex":null}},"silver_location":{"widgetType":"text","name":"silver_location","defaultValue":"","label":"silver location","options":{"widgetType":"text","validationRegex":null}},"FULL_LOAD":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}}},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663765081617,"submitTime":1663765081572,"finishTime":1663765081639,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"0baaf449-3cf0-4a4e-ad7a-76574bd710d5"},{"version":"CommandV1","origId":2709619314156550,"guid":"fd05803a-65f4-442a-bd43-b9b366aa371b","subtype":"command","commandType":"auto","position":5.0,"command":"print(table_name)\nprint(metafilepath)\nprint(staging_location)\nprint(curated_location)\nprint(curated_location_err)\nprint(silver_location)","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">ERDB\nbfss://dev@dtecuprodedaadl02.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv\n&#39;dbfs:/FileStore/ERDB/QI6_300_000023_IS_U_EE22_0000_ERDB_20220809_113555_0.CSV/ERDB/&#39;\n&#39;/ERDB/&#39;\n&#39;/ERDB/&#39;\n&#39;/ERDB/&#39;\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663764817393,"submitTime":1663764816575,"finishTime":1663764817406,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",275]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"fa324d7c-7da3-4375-9f65-ba2716c550a0"},{"version":"CommandV1","origId":2709619314156552,"guid":"a3ee55e0-9f63-4859-b203-6a64d03bdc48","subtype":"command","commandType":"auto","position":7.0,"command":"path = 'dbfs:/FileStore/ERDB/QI6_300_000023_IS_U_EE22_0000_ERDB_20220809_113555_0.CSV'\n\ntry:\n    s = 'newdf = spark.read.format(\"csv\").option(\"delimiter\", \"|\").option(\"header\",\"true\").option(\"inferSchema\",\"true\").load(' + path + ')'\n    print(s)\n    exec(s)\n    #logger.info(\"Reading datafiles from segregated location succeeded : refer cmd 6\")\nexcept Exception as e:\n    print(\"error #1\")\n\n","commandVersion":35,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">newdf = spark.read.format(&#34;csv&#34;).option(&#34;delimiter&#34;, &#34;|&#34;).option(&#34;header&#34;,&#34;true&#34;).option(&#34;inferSchema&#34;,&#34;true&#34;).load(dbfs:/FileStore/ERDB/QI6_300_000023_IS_U_EE22_0000_ERDB_20220809_113555_0.CSV)\nerror #1\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663765055872,"submitTime":1663765055840,"finishTime":1663765055888,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",287]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b8e98643-eff8-48c2-975a-b402763b767d"},{"version":"CommandV1","origId":2709619314156553,"guid":"41dcd13c-12f1-48d2-8a10-3c065281ae68","subtype":"command","commandType":"auto","position":8.0,"command":"# FUNCTION TO CLEAN HEADER WITH PROPER COLUMN NAMES FROM DATAFRAME\n\ndef revisit_header(df=newdf,table_n=table_name):\n    if fnmatch.fnmatch(df.columns[0],table_n + \"*\") == True:\n        for i in df.columns:\n            df = df.withColumnRenamed(i, i[len(table_n)+1:])\n        print(df.columns)\n        return df\n    else:\n        return df","commandVersion":1,"state":"error","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":"<span class=\"ansi-red-fg\">NameError</span>: name &#39;newdf&#39; is not defined","errorTraceType":"html","error":"<div class=\"ansiout\"><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-green-fg\">&lt;command-2709619314156553&gt;</span> in <span class=\"ansi-cyan-fg\">&lt;module&gt;</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      1</span> <span class=\"ansi-red-fg\"># FUNCTION TO CLEAN HEADER WITH PROPER COLUMN NAMES FROM DATAFRAME</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      2</span> \n<span class=\"ansi-green-fg\">----&gt; 3</span><span class=\"ansi-red-fg\"> </span><span class=\"ansi-green-fg\">def</span> revisit_header<span class=\"ansi-blue-fg\">(</span>df<span class=\"ansi-blue-fg\">=</span>newdf<span class=\"ansi-blue-fg\">,</span>table_n<span class=\"ansi-blue-fg\">=</span>table_name<span class=\"ansi-blue-fg\">)</span><span class=\"ansi-blue-fg\">:</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      4</span>     <span class=\"ansi-green-fg\">if</span> fnmatch<span class=\"ansi-blue-fg\">.</span>fnmatch<span class=\"ansi-blue-fg\">(</span>df<span class=\"ansi-blue-fg\">.</span>columns<span class=\"ansi-blue-fg\">[</span><span class=\"ansi-cyan-fg\">0</span><span class=\"ansi-blue-fg\">]</span><span class=\"ansi-blue-fg\">,</span>table_n <span class=\"ansi-blue-fg\">+</span> <span class=\"ansi-blue-fg\">&#34;*&#34;</span><span class=\"ansi-blue-fg\">)</span> <span class=\"ansi-blue-fg\">==</span> <span class=\"ansi-green-fg\">True</span><span class=\"ansi-blue-fg\">:</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      5</span>         <span class=\"ansi-green-fg\">for</span> i <span class=\"ansi-green-fg\">in</span> df<span class=\"ansi-blue-fg\">.</span>columns<span class=\"ansi-blue-fg\">:</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name &#39;newdf&#39; is not defined</div>","workflows":[],"startTime":1663764823846,"submitTime":1663764823846,"finishTime":1663764823956,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"726b87fc-22bb-4a22-b541-e29d410022c7"},{"version":"CommandV1","origId":2709619314156554,"guid":"51933d52-0a5b-46e4-b236-336fcef8af17","subtype":"command","commandType":"auto","position":9.0,"command":"newdf = revisit_header()","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5f5c2135-f7c8-4f13-bd14-3721b2883a97"},{"version":"CommandV1","origId":2709619314156555,"guid":"5ac0dbd3-6d71-460a-a4f0-43209dfe98e7","subtype":"command","commandType":"auto","position":10.0,"command":"# display(newdf)\ncols_from_file_source = newdf.columns","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e02b2e53-d493-460f-b560-260b9add72b7"},{"version":"CommandV1","origId":2709619314156556,"guid":"1d297452-7d24-48e1-b564-11653d4494c1","subtype":"command","commandType":"auto","position":11.0,"command":"%run \"../Metadata/Load_Metadata\"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"98e5bc0f-bc98-48e4-8d8d-435a894ade1d"},{"version":"CommandV1","origId":2709619314156557,"guid":"2bc0e329-89fa-4a12-81f1-507a0eaaae3c","subtype":"command","commandType":"auto","position":12.0,"command":"metadf = load_metadata_df(metafilepath)\n# display(metadf)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"97d0ed51-c7e4-4edf-9c1c-7b850c2a7717"},{"version":"CommandV1","origId":2709619314156558,"guid":"c19757d6-6f97-4f1a-a02a-851ec1b83121","subtype":"command","commandType":"auto","position":13.0,"command":"cols_from_metadata = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).rdd.map(lambda x : x[0]).collect()\nprint(cols_from_metadata)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"980f4afb-f8f6-4446-ae0e-15445895ec97"},{"version":"CommandV1","origId":2709619314156559,"guid":"1b8f44af-6184-489d-94cd-586682cefe7d","subtype":"command","commandType":"auto","position":14.0,"command":"print(cols_from_file_source)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a1ceab8e-cbf0-4841-9319-12fb498857dd"},{"version":"CommandV1","origId":2709619314156560,"guid":"828c2746-db25-4e55-9a59-c6bca568e71c","subtype":"command","commandType":"auto","position":15.0,"command":"# try:\n#   test_list1 = sorted(cols_from_file_source)\n#   test_list2 = sorted(cols_from_metadata)\n#   print(\"Schema Matches !!\")\n# except:\n#   print(\"Mismatch in schema\" + table_name)\n#   #dbutils.notebook.exit('stop')","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e719caa1-3113-4898-a861-77ce39b1ea1d"},{"version":"CommandV1","origId":2709619314156561,"guid":"8d08360e-d1c0-439b-88b5-7539eb259b45","subtype":"command","commandType":"auto","position":16.0,"command":"def generate_code_for_casting_columns_based_on_metadata(metadf,table_name,dfname,newdfname):\n  z = str(\"\")\n  cols = metadf.select(\"Field_Name\",\"delta_types\").where(col(\"Table_Name\")==table_name).rdd.map(lambda x : x[0]).collect()\n  col_types = metadf.select(\"Field_Name\",\"delta_types\").where(col(\"Table_Name\")==table_name).rdd.map(lambda x : x[1]).collect()\n  for i,j in zip(cols,col_types):\n    i = '\"' + i + '\"'\n    j = '\"' + j + '\"'\n    z = z + ('.withColumn(' + i + ',col(' + i + ').cast(' + j + '))')\n  return(newdfname + ' = ' + dfname + z)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"05285c8b-03bc-400e-ae52-867aa50365c6"},{"version":"CommandV1","origId":2709619314156562,"guid":"ab9e26a6-2d62-479b-b8ba-2521811da418","subtype":"command","commandType":"auto","position":17.0,"command":"try:\n    get_code = generate_code_for_casting_columns_based_on_metadata(metadf,table_name,'newdf','casted_df')\n    exec(get_code)\n    print(get_code)\n    logger.info(\"generate_code_for_casting_columns_based_on_metadata function succeeded : refer cmd 16\")\nexcept Exception as e:\n    logger.error(\"generate_code_for_casting_columns_based_on_metadata function FAILED : refer cmd 16 : \" + str(e))\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"53ea594a-b0d9-46c3-9c75-7de2f0b6203a"},{"version":"CommandV1","origId":2709619314156563,"guid":"4bc726bd-0fec-4fc3-adc8-a29c9a0b5e20","subtype":"command","commandType":"auto","position":18.0,"command":"# FUNCTION TO REMOVE DUPLICATE ROWS\n\ndef duplicates_removal(dups_df):\n  df = dups_df.drop_duplicates()\n  keyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\n  orderbycol = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\").isNull()).rdd.map(lambda x : x[0]).collect()\n\n  windowspec = Window.partitionBy(keyfields).orderBy(orderbycol[0])\n  table_archive = df.withColumn(\"row_number\",row_number().over(windowspec)).select(\"*\").where(col(\"row_number\")==1)\n  table_erroneous = df.withColumn(\"row_number\",row_number().over(windowspec)).select(\"*\").where(col(\"row_number\")>1)\n  return (table_archive,table_erroneous)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"94d78245-b40c-4920-808d-f26f53d5be65"},{"version":"CommandV1","origId":2709619314156564,"guid":"fa5c43c6-3c1b-4b19-9f27-2cca3897c80e","subtype":"command","commandType":"auto","position":19.0,"command":"archive_df,erroneous_df = duplicates_removal(casted_df)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"8734b31c-32dc-44c7-baff-7e3a64c34786"},{"version":"CommandV1","origId":2709619314156565,"guid":"ec74b081-2d14-4f27-b329-a01f2262fcdc","subtype":"command","commandType":"auto","position":20.0,"command":"def generate_code_for_adding_flag_columns(metadf,table_name,dfname,newdfname):\n    col1 = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Partition_Key\") == 'Y').rdd.map(lambda x : x[0]).collect()\n    if col1:\n        Logic_1 = newdfname + \" = \" + dfname + \".withColumn('partitioncol',lit('ARCHIVE')).withColumn('EPOCH_FLAG',lit('ARCHIVE'))\"\n    else:\n        Logic_1 = newdfname + \" = \" + dfname + \".withColumn('EPOCH_FLAG',lit('ARCHIVE'))\"\n    return(Logic_1)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"76b805e7-012c-4ea5-bc09-62192648f337"},{"version":"CommandV1","origId":2709619314156566,"guid":"9cd41b81-7fab-403e-a842-a25aa74b7461","subtype":"command","commandType":"auto","position":21.0,"command":"# GENERATE SCHEMA FOR ARCHIVE MAIN TABLE\n\ntry:\n    get_code = generate_code_for_adding_flag_columns(metadf,table_name,'archive_df','archive_part_col_added_df')\n    print(get_code)\n    exec(get_code)\n    logger.info(\"Generate Schema for Archive Main Table succeeded : refer cmd 20\")\nexcept Exception as e:\n    logger.error(\"Generate Schema for Archive Main Table FAILED : refer cmd 20 : \" + str(e))\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cd03c9dd-2b0d-4107-8e59-18c50cc2fb0d"},{"version":"CommandV1","origId":2709619314156567,"guid":"5a9e68c6-caf8-4bb5-ba73-f4cb43f8bacd","subtype":"command","commandType":"auto","position":22.0,"command":"# GENERATE SCHEMA FOR ERROR TABLE\n\ntry:\n    get_code = generate_code_for_adding_flag_columns(metadf,table_name,'erroneous_df','erroneous_part_col_added_df')\n    print(get_code)\n    exec(get_code)\n    logger.info(\"Generate Schema for Archive Error Table succeeded : refer cmd 21\")\nexcept Exception as e:\n    logger.error(\"Generate Schema for Archive Error Table FAILED : refer cmd 21 : \" + str(e))\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cb8f2bbd-3c8b-437a-a506-cfa30f9eddcc"},{"version":"CommandV1","origId":2709619314156568,"guid":"db1248a9-525a-463b-a6ba-7467be25da91","subtype":"command","commandType":"auto","position":23.0,"command":"archive_final_DF = archive_part_col_added_df.withColumn(\"EDA_Creation_date\",current_timestamp())\n# display(archive_final_DF)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"eef49ff5-e6e3-487f-9897-cdff70de591f"},{"version":"CommandV1","origId":2709619314156569,"guid":"f740ff35-d2ee-4485-947c-01dab3529e2c","subtype":"command","commandType":"auto","position":24.0,"command":"erroneous_final_DF = erroneous_part_col_added_df.withColumn(\"EDA_Creation_date\",current_timestamp())\n# display(erroneous_final_DF)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"4c1a74ae-f053-4878-be15-eb97de696cfb"},{"version":"CommandV1","origId":2709619314156570,"guid":"3b563ffb-5d0a-41e5-8ac6-f307c87913a6","subtype":"command","commandType":"auto","position":25.0,"command":"archive_write_DF = archive_final_DF.drop(\"row_number\")\nerroneous_write_DF = erroneous_final_DF.drop(\"row_number\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"18f495ac-5c2e-4e84-b15f-9e0664eca14a"},{"version":"CommandV1","origId":2709619314156571,"guid":"b00adf06-f177-4fa6-9223-a9b18b0fd575","subtype":"command","commandType":"auto","position":26.0,"command":"from delta.tables import *\nfrom pyspark.sql.functions import *","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"174ab3c0-46fe-4754-9bba-e6049123817e"},{"version":"CommandV1","origId":2709619314156572,"guid":"edcb105f-1ddb-4431-8501-0e1717b28a03","subtype":"command","commandType":"auto","position":27.0,"command":"# IF FULL_LOAD = Yes, OVERWRITE FILES/FOLDER IN TARGET LOCATION ELSE PERFORM MERGE \n\ntry:    \n    if (str(FULL_LOAD) == 'Yes'):\n        dbutils.fs.rm(curated_location,True)\n        dbutils.fs.rm(curated_location_err,True)\n        s = 'archive_write_DF.write.format(\"delta\").mode(\"overwrite\").save(' + curated_location + ')'\n        exec(s)\n        s = 'erroneous_write_DF.write.format(\"delta\").mode(\"overwrite\").save(' + curated_location_err + ')'\n        exec(s)\n    else:\n        keyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\n        cond = ''\n        exitindex = len(keyfields)-1\n        for i in keyfields:\n            if keyfields.index(i) == exitindex:\n                cond = cond + 'logs.' + i + ' = newDedupedLogs.' + i\n            else:\n                cond = cond + 'logs.' + i + ' = newDedupedLogs.' + i + ' AND '\n        \n        cond = cond + ' AND logs.EDA_Creation_date < newDedupedLogs.EDA_Creation_date'\n        print(cond)\n    \n    \n        s = \"deltaTable = DeltaTable.forPath(spark, \" + curated_location + \")\"\n        exec(s)\n        newDedupedLogs = archive_write_DF\n    \n        deltaTable.alias(\"logs\").merge(\n            newDedupedLogs.alias(\"newDedupedLogs\"),\n            cond) \\\n          .whenMatchedUpdateAll() \\\n          .whenNotMatchedInsertAll() \\\n          .execute()\nexcept Exception as e:\n    logger.error(\"MERGE FAILED : refer cmd 26 : \" + str(e))","commandVersion":5,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"be1e567d-cb4a-4069-83a6-1808d6084785"},{"version":"CommandV1","origId":2709619314156573,"guid":"b2c109b5-eb90-4fe7-acee-5ff0a781abf7","subtype":"command","commandType":"auto","position":28.0,"command":"# Merge data to Final table\n\nkeyfields = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Key_Field\") == 'X').rdd.map(lambda x : x[0]).collect()\ncond = ''\nexitindex = len(keyfields)-1\nfor i in keyfields:\n    if keyfields.index(i) == exitindex:\n        cond = cond + 'logs.' + i + ' = newDedupedLogs.' + i\n    else:\n        cond = cond + 'logs.' + i + ' = newDedupedLogs.' + i + ' AND '\n        \nprint(cond)\n\ns2 = \"finaldeltaTable = DeltaTable.forPath(spark, \" + silver_location + \")\"\nexec(s2)\nnewDedupedLogs = archive_write_DF\nnewDedupedLogs.createOrReplaceTempView(\"newDedupedLogs\")\n","commandVersion":13,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"newDedupedLogs","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"MANDT","nullable":true,"type":"string"},{"metadata":{},"name":"LAUFD","nullable":true,"type":"string"},{"metadata":{},"name":"LAUFI","nullable":true,"type":"string"},{"metadata":{},"name":"GPART","nullable":true,"type":"string"},{"metadata":{},"name":"VKONT","nullable":true,"type":"string"},{"metadata":{},"name":"MAZAE","nullable":true,"type":"string"},{"metadata":{},"name":"AKZAE","nullable":true,"type":"string"},{"metadata":{},"name":"ATEXT","nullable":true,"type":"string"},{"metadata":{},"name":"TABNAME","nullable":true,"type":"string"},{"metadata":{},"name":"TABKEY","nullable":true,"type":"string"},{"metadata":{},"name":"DISCNO","nullable":true,"type":"string"},{"metadata":{},"name":"XFILE","nullable":true,"type":"string"},{"metadata":{},"name":"partitioncol","nullable":true,"type":"string"},{"metadata":{},"name":"EPOCH_FLAG","nullable":true,"type":"string"},{"metadata":{},"name":"EDA_Creation_date","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1663750168104,"submitTime":1663750168044,"finishTime":1663750168127,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7d3accf9-056f-43c4-939f-9b0c66722c11"},{"version":"CommandV1","origId":2709619314156574,"guid":"5f704f26-18d1-4f27-b0b7-55c3e35d7696","subtype":"command","commandType":"auto","position":29.0,"command":"# %sql\n\n# MERGE INTO delta.`abfss://dev@dtecuprodedaadl10.dfs.core.windows.net/curated/ISU_archive/silver_testcopy/FKKMAKT/` AS logs \n# USING newDedupedLogs AS newDedupedLogs \n# ON logs.MANDT = newDedupedLogs.MANDT AND logs.LAUFD = newDedupedLogs.LAUFD AND logs.LAUFI = newDedupedLogs.LAUFI AND logs.GPART = newDedupedLogs.GPART AND logs.VKONT = newDedupedLogs.VKONT AND logs.MAZAE = newDedupedLogs.MAZAE AND logs.AKZAE = newDedupedLogs.AKZAE\n# WHEN MATCHED AND logs.EPOCH_FLAG = 'ARCHIVE' \n# THEN UPDATE SET *\n# WHEN NOT MATCHED \n# THEN INSERT *","commandVersion":22,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5c96702e-2927-40c1-af39-d72f8b9ab646"},{"version":"CommandV1","origId":2709619314156575,"guid":"2fc4de9c-3b81-499a-8fd3-ca20c288dcb6","subtype":"command","commandType":"auto","position":30.0,"command":"print(f\"\"\"\n\n\n\nMERGE INTO delta.`{silver_location[1:-1]}` AS logs\nUSING newDedupedLogs AS newDedupedLogs\nON {cond}\nWHEN MATCHED AND logs.EPOCH_FLAG = 'ARCHIVE'\nTHEN UPDATE SET *\nWHEN NOT MATCHED\nTHEN INSERT *\n\"\"\")","commandVersion":3,"state":"error","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":"<span class=\"ansi-red-fg\">NameError</span>: name &#39;silver_location&#39; is not defined","errorTraceType":"html","error":"<div class=\"ansiout\"><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-green-fg\">&lt;command-553411872537840&gt;</span> in <span class=\"ansi-cyan-fg\">&lt;module&gt;</span>\n<span class=\"ansi-green-intense-fg ansi-bold\">      3</span> \n<span class=\"ansi-green-intense-fg ansi-bold\">      4</span> \n<span class=\"ansi-green-fg\">----&gt; 5</span><span class=\"ansi-red-fg\"> </span>MERGE INTO delta<span class=\"ansi-blue-fg\">.</span><span class=\"ansi-red-fg\">`</span><span class=\"ansi-blue-fg\">{</span>silver_location<span class=\"ansi-blue-fg\">[</span><span class=\"ansi-cyan-fg\">1</span><span class=\"ansi-blue-fg\">:</span><span class=\"ansi-blue-fg\">-</span><span class=\"ansi-cyan-fg\">1</span><span class=\"ansi-blue-fg\">]</span><span class=\"ansi-blue-fg\">}</span><span class=\"ansi-red-fg\">`</span> AS logs\n<span class=\"ansi-green-intense-fg ansi-bold\">      6</span> USING newDedupedLogs AS newDedupedLogs\n<span class=\"ansi-green-intense-fg ansi-bold\">      7</span> ON <span class=\"ansi-blue-fg\">{</span>cond<span class=\"ansi-blue-fg\">}</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name &#39;silver_location&#39; is not defined</div>","workflows":[],"startTime":1663758285535,"submitTime":1663758285535,"finishTime":1663758285732,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6720ea83-c3e7-4fae-9e9d-02101f0f55d4"},{"version":"CommandV1","origId":2709619314156576,"guid":"eeb76452-b4b6-481d-987e-a611a53780ad","subtype":"command","commandType":"auto","position":31.0,"command":"spark.sql(f\"\"\"\n\n\n\nMERGE INTO delta.`{silver_location[1:-1]}` AS logs\nUSING newDedupedLogs AS newDedupedLogs\nON {cond}\nWHEN MATCHED AND logs.EPOCH_FLAG = 'ARCHIVE'\nTHEN UPDATE SET *\nWHEN NOT MATCHED\nTHEN INSERT *\n\"\"\")","commandVersion":3,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"bda5a7f6-2e85-4b54-b86e-90f1d622b545"}],"dashboards":[],"guid":"1ae47267-f845-4070-a8da-b9bc0955c7eb","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"curated_location":{"nuid":"40e2e5ea-20d0-4549-aeb8-cc0afe8beba0","currentValue":"","widgetInfo":{"widgetType":"text","name":"curated_location","defaultValue":"","label":"curated location","options":{"widgetType":"text","validationRegex":null}}},"table_name":{"nuid":"482cde28-0b5c-4356-ae2f-67f32a2f6f96","currentValue":"ERDB","widgetInfo":{"widgetType":"text","name":"table_name","defaultValue":"","label":"table name","options":{"widgetType":"text","validationRegex":null}}},"metafilepath":{"nuid":"5638f1b1-4590-4d1d-80d4-7b7103c79fcb","currentValue":"bfss://dev@dtecuprodedaadl02.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv","widgetInfo":{"widgetType":"text","name":"metafilepath","defaultValue":"","label":"METADATA FILEPATH","options":{"widgetType":"text","validationRegex":null}}},"dbfslogbasepath":{"nuid":"5da80f45-04fe-4fae-aed1-b676751802a2","currentValue":"dbfs:/FileStore/ERDB","widgetInfo":{"widgetType":"text","name":"dbfslogbasepath","defaultValue":"","label":"DBFS LOG FILE PATH","options":{"widgetType":"text","validationRegex":null}}},"staging_location":{"nuid":"bd3fba4e-3883-4bfa-be9d-9722d94597b6","currentValue":"dbfs:/FileStore/ERDB/QI6_300_000023_IS_U_EE22_0000_ERDB_20220809_113555_0.CSV","widgetInfo":{"widgetType":"text","name":"staging_location","defaultValue":"","label":"staging location","options":{"widgetType":"text","validationRegex":null}}},"curated_location_err":{"nuid":"3eaeb54e-a630-4701-a879-a981f6500a31","currentValue":"","widgetInfo":{"widgetType":"text","name":"curated_location_err","defaultValue":"","label":"curated location for error table","options":{"widgetType":"text","validationRegex":null}}},"silver_location":{"nuid":"28e57d4c-513d-49f0-bdd7-53f2f743d062","currentValue":"","widgetInfo":{"widgetType":"text","name":"silver_location","defaultValue":"","label":"silver location","options":{"widgetType":"text","validationRegex":null}}},"FULL_LOAD":{"nuid":"3a4b4075-5406-4186-ab14-55ac68c9ad36","currentValue":"No","widgetInfo":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}