{"version":"NotebookV1","origId":736389190656353,"name":"STD FINAL Dynamic Table Creation Using MetaTable","language":"python","commands":[{"version":"CommandV1","origId":736389190656354,"guid":"c7073f27-b20e-4879-bb9c-a957db04ecbd","subtype":"command","commandType":"auto","position":2.0,"command":"#%run \"/EDA/Data Engineer/Framework/Secrets-Databricks-Cache\"","commandVersion":2,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"78462d04-9b0e-4b70-97b8-654c3ccbc79f"},{"version":"CommandV1","origId":736389190656355,"guid":"ace679aa-30fd-4a8f-a10b-b4e59c4c6f9c","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.functions import *","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457397585,"submitTime":1664457397549,"finishTime":1664457397603,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"78f2c2cd-b6fc-4abf-a026-c736b04aea87"},{"version":"CommandV1","origId":736389190656356,"guid":"79c1fc59-cd8f-4734-9f01-1659eeb54158","subtype":"command","commandType":"auto","position":4.0,"command":"# SET LOAD TYPE (FULL LOAD = Yes/No)\ndbutils.widgets.text(\"FULL_LOAD\", \"No\", \"FULL LOAD\")\nFULL_LOAD = dbutils.widgets.get(\"FULL_LOAD\")\n\n# SET ENVIRONMENT FOR DATA LAKE (02 OR 10 OR etc)\ndbutils.widgets.text(\"env\", \"02\", \"ADLS ENVIRONMENT\")\nenv = dbutils.widgets.get(\"env\")\n\n#SET TABLE LIST (nonpii OR pii) \ndbutils.widgets.text(\"pii_or_nonpii\", \"nonpii\", \"TABLE PREFERENCE( NONPII/PII)\")\npii_or_nonpii = dbutils.widgets.get(\"pii_or_nonpii\")\n\n# SET MANUAL LIST OF TABLES (for example = table1 table2 table3 etc)\ndbutils.widgets.text(\"manual_list_str\", \"\", \"MANUAL TABLE LIST\")\nmanual_list_str = dbutils.widgets.get(\"manual_list_str\")\nmanual_list  =  (list(manual_list_str.split()))\n\n# SET DATABASE NAME\ndbutils.widgets.text(\"db_name\", \"cods_nonprod_active\", \"BRONZE DATABASE NAME\")\ndb_name = dbutils.widgets.get(\"db_name\")\n\n# SET DATABASE NAME\ndbutils.widgets.text(\"final_db_name\", \"cods_nonprod\", \"FINAL DATABASE NAME\")\nfinal_db_name = dbutils.widgets.get(\"final_db_name\")\n\n#SET BASEPATH\nbasepath = 'abfss://dev@dtecuprodedaadl' + env + '.dfs.core.windows.net/'\n\n#SET SILVER LOCATION PATH \ndbutils.widgets.text(\"silver_location\", \"curated/ISU_archive/silver\", \"SILVER LOC\")\nsilver_location = basepath + dbutils.widgets.get(\"silver_location\")\n\n# SET METADATA FILEPATH FROM ADLS (For example  = ISU_archive_support/metadata/Final_metadata.csv)\ndbutils.widgets.text(\"metaadlspath\", \"ISU_archive_support/metadata/Final_metadata.csv\", \"METADATA FILE LOC\")\nmetaadlspath = dbutils.widgets.get(\"metaadlspath\")\n\n# SET METADATA FILE FULL PATH TO ADLS\nmetafilepath = basepath + metaadlspath\n","commandVersion":71,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{"db_name":"","pii_or_nonpii":"pii","manual_list_str":"","silver_location":"curated/ISU_archive/silver","metaadlspath":"ISU_archive_support/metadata/Final_metadata.csv","final_db_name":"","FULL_LOAD":"No","env":"10"},"addedWidgets":{"db_name":{"widgetType":"text","name":"db_name","defaultValue":"cods_nonprod_active","label":"BRONZE DATABASE NAME","options":{"widgetType":"text","validationRegex":null}},"pii_or_nonpii":{"widgetType":"text","name":"pii_or_nonpii","defaultValue":"nonpii","label":"TABLE PREFERENCE( NONPII/PII)","options":{"widgetType":"text","validationRegex":null}},"manual_list_str":{"widgetType":"text","name":"manual_list_str","defaultValue":"","label":"MANUAL TABLE LIST","options":{"widgetType":"text","validationRegex":null}},"silver_location":{"widgetType":"text","name":"silver_location","defaultValue":"curated/ISU_archive/silver","label":"SILVER LOC","options":{"widgetType":"text","validationRegex":null}},"metaadlspath":{"widgetType":"text","name":"metaadlspath","defaultValue":"ISU_archive_support/metadata/Final_metadata.csv","label":"METADATA FILE LOC","options":{"widgetType":"text","validationRegex":null}},"final_db_name":{"widgetType":"text","name":"final_db_name","defaultValue":"cods_nonprod","label":"FINAL DATABASE NAME","options":{"widgetType":"text","validationRegex":null}},"FULL_LOAD":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}},"env":{"widgetType":"text","name":"env","defaultValue":"02","label":"ADLS ENVIRONMENT","options":{"widgetType":"text","validationRegex":null}}},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457399835,"submitTime":1664457399799,"finishTime":1664457399863,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b574d1f2-d22a-44a3-9c65-6ab40a3a0400"},{"version":"CommandV1","origId":736389190656357,"guid":"d9f115fb-b530-49a3-be38-e8286df84fde","subtype":"command","commandType":"auto","position":5.0,"command":"print(\"basepath : \" + basepath)\nprint(\"db_name : \" + db_name)\nprint(\"final_db_name : \" + final_db_name)\nprint(\"FULL_LOAD : \" + FULL_LOAD)\nprint(\"pii_or_nonpii : \" + pii_or_nonpii)\nprint(\"manual_list : \" + manual_list_str)\nprint(\"silver_location : \" + silver_location)\nprint(\"metafilepath : \" + metafilepath)","commandVersion":28,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">basepath : abfss://dev@dtecuprodedaadl10.dfs.core.windows.net/\ndb_name : \nfinal_db_name : \nFULL_LOAD : No\npii_or_nonpii : pii\nmanual_list : \nsilver_location : abfss://dev@dtecuprodedaadl10.dfs.core.windows.net/curated/ISU_archive/silver\nmetafilepath : abfss://dev@dtecuprodedaadl10.dfs.core.windows.net/ISU_archive_support/metadata/Final_metadata.csv\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457403731,"submitTime":1664457403697,"finishTime":1664457403749,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",378]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"30cf97df-3026-421a-93d9-9a57bc9d42c1"},{"version":"CommandV1","origId":736389190656359,"guid":"7b424cd5-f935-4f5e-b57d-0610b551105e","subtype":"command","commandType":"auto","position":7.0,"command":"%run \"../Metadata/Load_Metadata\"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457438734,"submitTime":1664457438734,"finishTime":1664457439174,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5b73131a-4088-42b2-902a-7a3e8c13a470"},{"version":"CommandV1","origId":736389190656363,"guid":"f5d323e9-d962-4899-9298-564b1f80fdff","subtype":"command","commandType":"auto","position":8.0,"command":"metadf = load_metadata_df(metafilepath)","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"metadf","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"Source","nullable":true,"type":"string"},{"metadata":{},"name":"Table_Name","nullable":true,"type":"string"},{"metadata":{},"name":"Table_Position","nullable":true,"type":"string"},{"metadata":{},"name":"Field_Name","nullable":true,"type":"string"},{"metadata":{},"name":"Data_Type","nullable":true,"type":"string"},{"metadata":{},"name":"Key_Field","nullable":true,"type":"string"},{"metadata":{},"name":"Description","nullable":true,"type":"string"},{"metadata":{},"name":"Partition_Key","nullable":true,"type":"string"},{"metadata":{},"name":"Partition_Key_Encoding","nullable":true,"type":"string"},{"metadata":{},"name":"delta_types","nullable":false,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457469974,"submitTime":1664457469925,"finishTime":1664457470823,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6d835566-49f0-4274-a25a-e6da0a600430"},{"version":"CommandV1","origId":736389190656374,"guid":"95b30ec4-1d80-4d33-a96e-5f13d3430f67","subtype":"command","commandType":"auto","position":6.0,"command":"print(silver_location)\nfileloc = dbutils.fs.ls(silver_location)\n\n# LIST OF TABLES FROM DIRECTORY \ntablelist1 = list(map(lambda p: p.name[:-1].upper(), fileloc))\n\n# LIST OF ALL NONPII TABLES\nnonpiitablelist = ['CDHDR','CDPOS','DBERCHV','DBERCHZ1','DBERCHZ2','DBERCHZ3','DBERDL','DBERDLB','DFKKKO','DFKKOPK','DFKKOPKC','DFKKOPKX','DFKKZK','DFKKZPE','DFKKZPT','DFKKZS','EABL','EABLG','EMDUSDRQHEAD','EMDUSDRQINPUT','EMDUSDRQITEM','EMDUSDRQRESULT','ERCHC','ERCHO','ERDB','ERDO','ETTIFB','ETTIFN']\n\n# LIST OF ALL PII TABLES\npiitablelist = ['BCONT','DFKKCOLL','DFKKCOLLH','DFKKLOCKS','DFKKLOCKSH','DFKKOP','DFKKOPCOLL','DFKKOPW','DFKKZP','DFKKZV','ERCH','ERDK','FKKMACTIVITIES','FKKMAKO','FKKMAKT','FKKMAZE']\n\nif(pii_or_nonpii == 'nonpii'):\n    tablelist2 = nonpiitablelist\n    print(tablelist2)\nelif(pii_or_nonpii == 'pii'):\n    tablelist2 = piitablelist\n    print(tablelist2)\n\n# EFFECTIVE TABLE LIST\ntablelist = [value for value in tablelist1 if value in tablelist2]","commandVersion":3,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">abfss://dev@dtecuprodedaadl10.dfs.core.windows.net/curated/ISU_archive/silver\n[&#39;BCONT&#39;, &#39;DFKKCOLL&#39;, &#39;DFKKCOLLH&#39;, &#39;DFKKLOCKS&#39;, &#39;DFKKLOCKSH&#39;, &#39;DFKKOP&#39;, &#39;DFKKOPCOLL&#39;, &#39;DFKKOPW&#39;, &#39;DFKKZP&#39;, &#39;DFKKZV&#39;, &#39;ERCH&#39;, &#39;ERDK&#39;, &#39;FKKMACTIVITIES&#39;, &#39;FKKMAKO&#39;, &#39;FKKMAKT&#39;, &#39;FKKMAZE&#39;]\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457409971,"submitTime":1664457409934,"finishTime":1664457410106,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",417]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cd8fe352-fe3b-48dc-96ce-11b29f51316d"},{"version":"CommandV1","origId":736389190656375,"guid":"f588eb72-496a-4ce2-ad65-9449acacd53f","subtype":"command","commandType":"auto","position":6.5,"command":"# IF TABLE LIST IS ENTERED MANUALLY FROM WIDGET THEN USE MANUAL TABLE LIST ELSE USE AVAILABLE TABLES LIST \n\nif(manual_list):\n    tablelist = manual_list\n    print(tablelist)\nelse:\n    tablelist\n    print(tablelist)","commandVersion":4,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">[&#39;BCONT&#39;, &#39;DFKKCOLL&#39;, &#39;DFKKCOLLH&#39;, &#39;DFKKLOCKS&#39;, &#39;DFKKLOCKSH&#39;, &#39;DFKKOP&#39;, &#39;DFKKOPCOLL&#39;, &#39;DFKKOPW&#39;, &#39;DFKKZP&#39;, &#39;DFKKZV&#39;, &#39;ERCH&#39;, &#39;ERDK&#39;, &#39;FKKMACTIVITIES&#39;, &#39;FKKMAKO&#39;, &#39;FKKMAKT&#39;, &#39;FKKMAZE&#39;]\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457416934,"submitTime":1664457416890,"finishTime":1664457416951,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",339]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"69c22fd0-056c-4777-b01b-3fda94171d1d"},{"version":"CommandV1","origId":736389190656377,"guid":"a3046f1a-23fe-48d2-a7a3-e0806ede7f9c","subtype":"command","commandType":"auto","position":8.5,"command":"for tablename in tablelist:\n    table_name = tablename\n    with_reqd_col_DF = metadf.select(\"*\").where(col(\"Table_Name\") == table_name )\n    getschema_s = generate_schema(\"Field_Name\",\"delta_types\",\"Description\",with_reqd_col_DF,\"silver\")\n    print(getschema_s)\n    \n    main_table_view = table_name + '_STREAM_DISTINCT'\n    final_main_table = table_name\n    curated_location = \"'\" + silver_location + \"/\" + table_name + \"'\"\n    \n    print(db_name)\n    print(final_db_name)\n    print(main_table_view)\n    print(final_main_table)\n    print(curated_location)\n    \n    if(str(FULL_LOAD) == 'Yes'):\n        spark.sql(f\"\"\" DROP TABLE IF EXISTS {final_db_name}.{final_main_table} \"\"\")\n        spark.sql(f\"\"\" DROP VIEW IF EXISTS {db_name}.{main_table_view} \"\"\")\n        print(f\"\"\" DROP TABLE IF EXISTS {final_db_name}.{final_main_table} \"\"\")\n    \n    ifpartitiontable = metadf.select(\"Field_Name\").where(col(\"Table_Name\")==table_name).where(col(\"Partition_Key\") == 'Y').rdd.map(lambda x : x[0]).collect()\n    print(ifpartitiontable)\n    if ifpartitiontable:\n        print(f\"\"\" CREATE TABLE IF NOT EXISTS {final_db_name}.{final_main_table} {getschema_s} USING DELTA PARTITIONED BY (partitioncol) LOCATION {curated_location} \"\"\") \n        spark.sql(f\"\"\" CREATE TABLE IF NOT EXISTS {final_db_name}.{final_main_table} {getschema_s} USING DELTA PARTITIONED BY (partitioncol) LOCATION {curated_location} \"\"\")\n        spark.sql(f\"\"\" CREATE VIEW IF NOT EXISTS {db_name}.{main_table_view} AS SELECT * FROM {final_db_name}.{final_main_table} WHERE EPOCH_FLAG = 'CURRENT' \"\"\")   \n    else:\n        print(f\"\"\" CREATE TABLE IF NOT EXISTS {final_db_name}.{final_main_table} {getschema_s} USING DELTA LOCATION {curated_location} \"\"\")  \n        spark.sql(f\"\"\" CREATE TABLE IF NOT EXISTS {final_db_name}.{final_main_table} {getschema_s} USING DELTA LOCATION {curated_location} \"\"\")\n        spark.sql(f\"\"\" CREATE VIEW IF NOT EXISTS {db_name}.{main_table_view} AS SELECT * FROM {final_db_name}.{final_main_table} WHERE EPOCH_FLAG = 'CURRENT' \"\"\")\n        \n    print(\"DONE WITH TABLE : \" + table_name)","commandVersion":123,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"540e7b81-8b76-4d1b-acbd-a1548d11057b"},{"version":"CommandV1","origId":736389190656378,"guid":"6d248add-d3c8-4fd5-8d17-d920dce6fad1","subtype":"command","commandType":"auto","position":8.25,"command":"# FUNCTION TO GENERATE TABLE SCHEMA FROM META DATA FILE\n\ndef generate_schema(column_name,types_name,comment,M_DF,zone):\n    columns_list = M_DF.select(column_name).rdd.map(lambda x : x[0]).collect()\n    types_list = M_DF.select(types_name).rdd.map(lambda x : x[0]).collect()\n    col1 =\"(\"\n    col2 =\"\"\n    for i,j in zip(columns_list,types_list):\n        col1 = col1 + \" \" + i + \" \" + j + \" \" + ', '\n    partition_check = M_DF.select(\"Field_Name\").where(col(\"Partition_Key\") == 'Y').rdd.map(lambda x : x[0]).collect()\n    if zone == 'silver':\n        if partition_check:\n            return col1 + \"partitioncol STRING, EPOCH_FLAG STRING, EDA_Creation_date TIMESTAMP ) \"\n        else:\n            return col1 + \"EPOCH_FLAG STRING, EDA_Creation_date TIMESTAMP ) \"","commandVersion":3,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457483563,"submitTime":1664457483528,"finishTime":1664457483590,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"67fa90ec-c10c-42e1-be68-50736282c174"},{"version":"CommandV1","origId":736389190656379,"guid":"a8e01be3-7e70-45c4-a900-9ec0ab1b5b9b","subtype":"script","commandType":"auto","position":7.25,"command":"","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457438796,"submitTime":0,"finishTime":1664457438812,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":["7b424cd5-f935-4f5e-b57d-0610b551105e"],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"c72dfa99-5a5d-4e02-9824-1b5323724f9e"},{"version":"CommandV1","origId":736389190656380,"guid":"2c3da69e-be15-4036-abcb-24ba50bd5bea","subtype":"script","commandType":"auto","position":7.5,"command":"","commandVersion":80,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457438815,"submitTime":0,"finishTime":1664457438836,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":["7b424cd5-f935-4f5e-b57d-0610b551105e"],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b79b8f9b-d062-4fd3-b310-8342a785c7a0"},{"version":"CommandV1","origId":736389190656381,"guid":"a4403288-14de-4fff-8496-6eb1f7e74a3b","subtype":"script","commandType":"auto","position":7.75,"command":"","commandVersion":104,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">Your Metadata dataframe is loaded\nUse following syntax to grab it\n &lt;new dataframe&gt; = load_metadata_df(&lt;path of metadata csv&gt;) \n\n\nNOTE : csv path parameter is optional as Functions uses default path\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1664457438839,"submitTime":0,"finishTime":1664457438853,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":["7b424cd5-f935-4f5e-b57d-0610b551105e"],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",237]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"1beb3524-a0fc-41a8-b8e2-72722bf751f1"}],"dashboards":[],"guid":"7ed03cd8-ef74-419c-96a8-1149570d2e83","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"curated_location":{"nuid":"cb885277-a26b-4325-9c34-c34c80586282","currentValue":"","widgetInfo":{"widgetType":"text","name":"curated_location","defaultValue":"","label":"curated location","options":{"widgetType":"text","validationRegex":null}}},"table_name":{"nuid":"7b625fbe-2c4e-4913-a94f-4d86f38e2606","currentValue":"","widgetInfo":{"widgetType":"text","name":"table_name","defaultValue":"","label":"table name","options":{"widgetType":"text","validationRegex":null}}},"metafilepath":{"nuid":"939d88aa-24f0-4917-a832-7ac09a77f411","currentValue":"","widgetInfo":{"widgetType":"text","name":"metafilepath","defaultValue":"","label":"METADATA FILEPATH","options":{"widgetType":"text","validationRegex":null}}},"dbfslogbasepath":{"nuid":"6ba6edb8-343d-4d80-8572-b1b3f05f32d4","currentValue":"","widgetInfo":{"widgetType":"text","name":"dbfslogbasepath","defaultValue":"","label":"DBFS LOG FILE PATH","options":{"widgetType":"text","validationRegex":null}}},"db_name":{"nuid":"4df9e744-c3a4-4227-9d55-aed27704848a","currentValue":"","widgetInfo":{"widgetType":"text","name":"db_name","defaultValue":"cods_nonprod_active","label":"BRONZE DATABASE NAME","options":{"widgetType":"text","validationRegex":null}}},"pii_or_nonpii":{"nuid":"422b1710-8087-438b-879d-def1a7c04835","currentValue":"pii","widgetInfo":{"widgetType":"text","name":"pii_or_nonpii","defaultValue":"nonpii","label":"TABLE PREFERENCE( NONPII/PII)","options":{"widgetType":"text","validationRegex":null}}},"manual_list_str":{"nuid":"45a4a1c6-d1da-4814-94b5-4f25a03e1166","currentValue":"","widgetInfo":{"widgetType":"text","name":"manual_list_str","defaultValue":"","label":"MANUAL TABLE LIST","options":{"widgetType":"text","validationRegex":null}}},"silver_location":{"nuid":"dca02ab1-f5b1-4004-94fd-eeee9e314672","currentValue":"curated/ISU_archive/silver","widgetInfo":{"widgetType":"text","name":"silver_location","defaultValue":"curated/ISU_archive/silver","label":"SILVER LOC","options":{"widgetType":"text","validationRegex":null}}},"metaadlspath":{"nuid":"1c532f64-8cfb-4601-9984-b8820ccc4997","currentValue":"ISU_archive_support/metadata/Final_metadata.csv","widgetInfo":{"widgetType":"text","name":"metaadlspath","defaultValue":"ISU_archive_support/metadata/Final_metadata.csv","label":"METADATA FILE LOC","options":{"widgetType":"text","validationRegex":null}}},"final_db_name":{"nuid":"e546a6b0-8445-4739-b364-dd9639a7a62e","currentValue":"","widgetInfo":{"widgetType":"text","name":"final_db_name","defaultValue":"cods_nonprod","label":"FINAL DATABASE NAME","options":{"widgetType":"text","validationRegex":null}}},"FULL_LOAD":{"nuid":"631e03be-6679-477b-851b-058f57edfe66","currentValue":"No","widgetInfo":{"widgetType":"text","name":"FULL_LOAD","defaultValue":"No","label":"FULL LOAD","options":{"widgetType":"text","validationRegex":null}}},"bronze_location":{"nuid":"40d08c9e-d9a6-491b-83f8-32ce613f703a","currentValue":"","widgetInfo":{"widgetType":"text","name":"bronze_location","defaultValue":"","label":"bronze location","options":{"widgetType":"text","validationRegex":null}}},"env":{"nuid":"751988e8-b57e-4f7c-b14c-5d228bd984cb","currentValue":"10","widgetInfo":{"widgetType":"text","name":"env","defaultValue":"02","label":"ADLS ENVIRONMENT","options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":4,"widgetLayout":[]},"reposExportFormat":"SOURCE"}